This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.firebaserc
.gitignore
eslint.config.js
firebase.json
functions/.gitignore
functions/index.js
functions/package.json
index.html
package.json
postcss.config.js
public/favicon.png
public/logo.jpg
README.md
src/AjoutSeance.jsx
src/annuaire.jsx
src/App.css
src/App.jsx
src/assets/react.svg
src/components/ConfirmModal.jsx
src/components/HistoryModal.jsx
src/components/Skeleton.jsx
src/firebase.js
src/GestionGroupes.jsx
src/GestionSeance.jsx
src/Home.jsx
src/index.css
src/Login.jsx
src/main.jsx
src/Planning.jsx
src/seedData.js
src/StudentPortal.jsx
src/StudentSessionDetail.jsx
tailwind.config.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".firebaserc">
{
  "projects": {
    "default": "gestion-yoga"
  }
}
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="firebase.json">
{
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "disallowLegacyRuntimeConfig": true,
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ]
    }
  ]
}
</file>

<file path="functions/.gitignore">
node_modules/
*.local
</file>

<file path="postcss.config.js">
export default {
    plugins: {
        '@tailwindcss/postcss': {},
        autoprefixer: {},
    },
}
</file>

<file path="README.md">
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.
</file>

<file path="src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/ConfirmModal.jsx">
import React from 'react';

export default function ConfirmModal({ isOpen, title, children, confirmLabel = "Confirmer", cancelLabel = "Annuler", colorClass = "bg-teal-600", onConfirm, onCancel }) {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-[2px]" onClick={onCancel}>
            <div className="bg-white p-6 rounded-2xl shadow-2xl w-80 animate-in fade-in zoom-in-95" onClick={e => e.stopPropagation()}>
                <h3 className="text-xl font-playfair font-bold text-gray-800 mb-4">{title}</h3>
                <div className="mb-6">
                    {children}
                </div>
                <div className="flex gap-3">
                    <button onClick={onCancel} className="flex-1 py-2 rounded-lg font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition">
                        {cancelLabel}
                    </button>
                    <button onClick={onConfirm} className={`flex-1 py-2 rounded-lg font-bold text-white shadow-md ${colorClass} hover:opacity-90 transition`}>
                        {confirmLabel}
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/Skeleton.jsx">
import React from 'react';

export default function Skeleton({ className }) {
    return (
        <div className={`animate-pulse bg-gray-200 rounded ${className}`}></div>
    );
}
</file>

<file path="src/Login.jsx">
// src/Login.jsx
import { useState } from 'react';
import { signInWithEmailAndPassword } from 'firebase/auth';
import { auth } from './firebase';

export default function Login() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
            await signInWithEmailAndPassword(auth, email, password);
            // Pas besoin de redirection, App.jsx d√©tectera le changement d'√©tat
        } catch (err) {
            console.error(err);
            setError("Email ou mot de passe incorrect.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-200">
                <div className="text-center mb-8">
                    <h1 className="text-3xl font-playfair font-bold text-teal-800 mb-2">Yoga Tracker üßò‚Äç‚ôÄÔ∏è</h1>
                    <p className="text-gray-500">Acc√®s Professeur</p>
                </div>

                <form onSubmit={handleLogin} className="space-y-6">
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">Email</label>
                        <input
                            type="email"
                            required
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full border-gray-300 border p-3 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition"
                            placeholder="admin@yoga.com"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">Mot de passe</label>
                        <input
                            type="password"
                            required
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full border-gray-300 border p-3 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        />
                    </div>

                    {error && (
                        <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-100 text-center font-bold">
                            {error}
                        </div>
                    )}

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-teal-700 text-white font-bold py-3 rounded-lg hover:bg-teal-800 transition shadow-lg transform active:scale-95 flex justify-center"
                    >
                        {loading ? "Connexion..." : "Se connecter"}
                    </button>
                </form>
            </div>
        </div>
    );
}
</file>

<file path="src/seedData.js">
import { db } from './firebase';
import { collection, addDoc, getDocs, deleteDoc } from 'firebase/firestore';

const GROUPES_A_CREER = [
    { nom: 'Lundi Matin 1', jour: 1, heureDebut: '09:00', duree: 90 },
    { nom: 'Lundi Matin 2', jour: 1, heureDebut: '10:45', duree: 90 },
    { nom: 'Lundi Soir', jour: 1, heureDebut: '18:00', duree: 90 },
    { nom: 'Mardi Soir', jour: 2, heureDebut: '18:00', duree: 90 },
    { nom: 'Mercredi Matin 1', jour: 3, heureDebut: '09:00', duree: 90 },
    { nom: 'Mercredi Matin 2', jour: 3, heureDebut: '10:45', duree: 90 },
    { nom: 'Mercredi Soir', jour: 3, heureDebut: '17:15', duree: 90 },
    { nom: 'Jeudi Matin', jour: 4, heureDebut: '09:00', duree: 90 },
    { nom: 'Vendredi Soir 1', jour: 5, heureDebut: '17:00', duree: 90 },
    { nom: 'Vendredi Soir 2', jour: 5, heureDebut: '18:45', duree: 90 },
];

export const seedGroups = async () => {
    if (!confirm("Attention : Cela va r√©initialiser tous les groupes √† 7 places. Continuer ?")) return;

    try {
        const querySnapshot = await getDocs(collection(db, "groupes"));
        const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);

        for (const groupe of GROUPES_A_CREER) {
            await addDoc(collection(db, "groupes"), {
                ...groupe,
                places: 7, // <--- C'est ici qu'on a chang√©
                actif: true
            });
        }

        alert("‚úÖ Groupes r√©initialis√©s avec 7 places !");
        window.location.reload();
    } catch (error) {
        console.error("Erreur:", error);
    }
};
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
    content: [
        "./index.html",
        "./src/**/*.{js,ts,jsx,tsx}",
    ],
    theme: {
        extend: {},
    },
    plugins: [],
}
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

functions/ma-cle.js
</file>

<file path="functions/package.json">
{
  "name": "functions",
  "description": "Cloud Functions for Firebase",
  "scripts": {
    "serve": "firebase emulators:start --only functions",
    "shell": "firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "22"
  },
  "main": "index.js",
  "dependencies": {
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^5.0.0",
    "node-fetch": "^2.7.0"
  },
  "private": true
}
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cours Yoga</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="src/AjoutSeance.jsx">
import { useState, useEffect } from 'react';
import { db } from './firebase';
import { collection, addDoc, updateDoc, doc, deleteDoc } from 'firebase/firestore'; // Import deleteDoc

export default function AjoutSeance({ onClose, onSuccess, initialData }) {
    const [formData, setFormData] = useState({
        nom: 'S√©ance Exceptionnelle',
        date: '',
        heureDebut: '18:00',
        duree: 90,
        places: 10,
        theme: '',
        type: 'ajout'
    });

    useEffect(() => {
        if (initialData) {
            setFormData(prev => ({ ...prev, ...initialData }));
        }
    }, [initialData]);

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const sessionData = {
                nom: formData.nom,
                heureDebut: formData.heureDebut,
                duree: parseInt(formData.duree),
                places: parseInt(formData.places),
                theme: formData.theme || ""
            };

            if (initialData && initialData.id) {
                const docId = initialData.originalExceptionId || initialData.id;
                await updateDoc(doc(db, "exceptions", docId), {
                    date: formData.date,
                    newSessionData: sessionData
                });
            }
            else {
                await addDoc(collection(db, "exceptions"), {
                    date: formData.date,
                    type: "ajout",
                    groupeId: "ajout_" + Date.now(),
                    newSessionData: sessionData
                });
            }

            onSuccess();
            onClose();
        } catch (error) {
            console.error("Erreur lors de l'enregistrement :", error);
            alert("Une erreur est survenue lors de l'enregistrement.");
        }
    };

    // --- FONCTION SUPPRESSION ---
    const handleDelete = async () => {
        if (!initialData || !initialData.id) return;

        if (confirm("‚ö†Ô∏è Voulez-vous vraiment SUPPRIMER d√©finitivement cette s√©ance ?\n\nCette action est irr√©versible.")) {
            try {
                const docId = initialData.originalExceptionId || initialData.id;
                await deleteDoc(doc(db, "exceptions", docId));
                onSuccess();
                onClose();
            } catch (error) {
                console.error("Erreur suppression:", error);
                alert("Erreur lors de la suppression.");
            }
        }
    };

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in-95">

                <div className="bg-purple-700 p-4 text-white flex justify-between items-center">
                    <h2 className="text-lg font-bold font-playfair flex items-center gap-2">
                        ‚ú® {initialData?.id ? "Modifier la S√©ance" : "Nouvelle S√©ance Unique"}
                    </h2>
                    <button onClick={onClose} className="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm transition">‚úï</button>
                </div>

                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Nom de la s√©ance</label>
                        <input
                            type="text"
                            placeholder="ex: Atelier Yoga du Dos"
                            value={formData.nom}
                            onChange={e => setFormData({ ...formData, nom: e.target.value })}
                            className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none font-bold text-gray-800"
                            required
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Th√®me / Description</label>
                        <textarea
                            placeholder="D√©crivez le contenu de la s√©ance (optionnel)..."
                            value={formData.theme}
                            onChange={e => setFormData({ ...formData, theme: e.target.value })}
                            className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-sm h-24 resize-none"
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Date</label>
                            <input
                                type="date"
                                value={formData.date}
                                onChange={e => setFormData({ ...formData, date: e.target.value })}
                                className="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Heure D√©but</label>
                            <input
                                type="time"
                                value={formData.heureDebut}
                                onChange={e => setFormData({ ...formData, heureDebut: e.target.value })}
                                className="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                                required
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Dur√©e (min)</label>
                            <input
                                type="number"
                                value={formData.duree}
                                onChange={e => setFormData({ ...formData, duree: e.target.value })}
                                className="w-full border border-gray-300 p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-center font-bold"
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-purple-600 mb-1 uppercase">Nb. Places</label>
                            <input
                                type="number"
                                value={formData.places}
                                onChange={e => setFormData({ ...formData, places: e.target.value })}
                                className="w-full border border-purple-200 bg-white p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none text-center font-bold text-purple-800"
                            />
                        </div>
                    </div>

                    <div className="flex gap-3 pt-2">
                        {/* BOUTON SUPPRIMER (Seulement si modification) */}
                        {initialData?.id && (
                            <button
                                type="button"
                                onClick={handleDelete}
                                className="px-4 py-3 rounded-xl font-bold text-red-600 bg-red-50 border border-red-100 hover:bg-red-100 transition"
                                title="Supprimer d√©finitivement"
                            >
                                üóëÔ∏è
                            </button>
                        )}

                        <button
                            type="button"
                            onClick={onClose}
                            className="flex-1 px-4 py-3 rounded-xl font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 transition"
                        >
                            Annuler
                        </button>
                        <button
                            type="submit"
                            className="flex-1 px-4 py-3 rounded-xl font-bold text-white bg-purple-600 hover:bg-purple-700 shadow-lg shadow-purple-200 transition transform active:scale-95"
                        >
                            Enregistrer
                        </button>
                    </div>

                </form>
            </div>
        </div>
    );
}
</file>

<file path="src/components/HistoryModal.jsx">
import { useState, useEffect } from 'react';
import { db } from '../firebase';
import { collection, query, orderBy, getDocs, limit } from 'firebase/firestore';

export default function HistoryModal({ student, onClose }) {
    const [history, setHistory] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchHistory = async () => {
            try {
                // On r√©cup√®re les 20 derniers mouvements
                const q = query(
                    collection(db, "eleves", student.id, "history"),
                    orderBy("date", "desc"),
                    limit(20)
                );
                const snap = await getDocs(q);
                const historyData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setHistory(historyData);
            } catch (err) {
                console.error("Erreur historique:", err);
            } finally {
                setLoading(false);
            }
        };

        fetchHistory();
    }, [student.id]);

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh] m-4" onClick={e => e.stopPropagation()}>

                {/* Header */}
                <div className="bg-teal-900 p-4 flex justify-between items-center text-white">
                    <h3 className="font-playfair font-bold text-lg">Historique des s√©ances</h3>
                    <button onClick={onClose} className="hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">‚úï</button>
                </div>

                {/* Contenu */}
                <div className="flex-1 overflow-y-auto p-4 bg-gray-50">
                    {loading ? (
                        <div className="space-y-3">
                            {[1, 2, 3].map(i => <div key={i} className="h-16 bg-gray-200 rounded-lg animate-pulse"></div>)}
                        </div>
                    ) : history.length === 0 ? (
                        <div className="text-center py-10 text-gray-400 italic">
                            Aucun historique r√©cent.
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {history.map(item => {
                                const isPositive = item.delta > 0;
                                const isNeutral = item.delta === 0;

                                return (
                                    <div key={item.id} className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center">
                                        <div>
                                            <div className="font-bold text-gray-800 text-sm">{item.motif}</div>
                                            <div className="text-xs text-gray-400 mt-1">
                                               {item.date?.toDate().toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                            </div>
                                        </div>
                                        <div className={`font-bold text-lg ${isNeutral ? 'text-gray-400' : (isPositive ? 'text-green-600' : 'text-red-500')}`}>
                                            {isPositive ? '+' : ''}{item.delta}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>

                <div className="p-4 bg-white border-t text-center text-xs text-gray-400">
                    Seuls les 20 derniers mouvements sont affich√©s.
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/firebase.js">
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getFirestore } from "firebase/firestore";
import { getAuth } from "firebase/auth";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBqlYXify9CDjqdYuCLBuAd7W76_Xd43Yg",
    authDomain: "gestion-yoga.firebaseapp.com",
    projectId: "gestion-yoga",
    storageBucket: "gestion-yoga.firebasestorage.app",
    messagingSenderId: "258116537790",
    appId: "1:258116537790:web:f15de802569b5a4f22fdef"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
export const db = getFirestore(app);
export const auth = getAuth(app);
</file>

<file path="src/index.css">
@import "tailwindcss";

/* Vous pouvez ajouter vos r√®gles globales personnalis√©es ici plus tard si n√©cessaire, 
   mais pour l'instant, laissez Tailwind g√©rer le style. */
</file>

<file path="src/main.jsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'
import { BrowserRouter } from 'react-router-dom' // <--- IMPORT

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <BrowserRouter> {/* <--- WRAPPER */}
      <App />
    </BrowserRouter>
  </React.StrictMode>,
)
</file>

<file path="package.json">
{
  "name": "gestion-yoga",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "firebase": "^12.6.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-hot-toast": "^2.6.0",
    "react-router-dom": "^7.10.1"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@tailwindcss/postcss": "^4.1.17",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.22",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.17",
    "vite": "^7.2.4"
  }
}
</file>

<file path="src/App.jsx">
import { useState, useEffect } from 'react';
import { Routes, Route, Navigate } from 'react-router-dom';
import { onAuthStateChanged, signOut } from 'firebase/auth';
import { auth } from './firebase';
import { Toaster } from 'react-hot-toast';

import Planning from './Planning';
import Annuaire from './annuaire.jsx';
import Login from './Login';
import StudentPortal from './StudentPortal';
import Home from './Home';

// --- COMPOSANT WRAPPER POUR PROT√âGER LA ROUTE ADMIN ---
const AdminRoute = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  if (loading) return <div className="p-10 text-center">Chargement Admin...</div>;

  // Si pas connect√©, on redirige vers le Login
  if (!user) return <Login />;

  // Si connect√©, on affiche l'app Admin
  return children;
};


// --- APP PRINCIPALE AVEC ROUTING ---
function App() {
  return (
    <>
      {/* Configuration globale des notifications (Toasts) */}
      <Toaster
        position="top-center"
        toastOptions={{
          duration: 3000,
          style: { background: '#333', color: '#fff' }
        }}
      />

      <Routes>
        {/* Route 1 : Page d'Accueil Publique */}
        <Route path="/" element={<Home />} />

        {/* Route 2 : Le Portail √âl√®ve (Renomm√© en /student pour correspondre au bouton de l'accueil) */}
        <Route path="/student" element={<StudentPortal />} />

        {/* Route 3 : Admin S√©curis√©e */}
        <Route path="/admin" element={
          <AdminRoute>
            <AdminDashboard />
          </AdminRoute>
        } />

        {/* S√©curit√© : Redirection vers l'accueil si l'URL est inconnue */}
        <Route path="*" element={<Navigate to="/" replace />} />
      </Routes>
    </>
  );
}

// --- DASHBOARD ADMIN ---
function AdminDashboard() {
  const [ongletActif, setOngletActif] = useState('planning');

  const handleLogout = async () => {
    await signOut(auth);
    window.location.href = "/"; // Force reload vers l'accueil
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow-sm sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4">
          <div className="flex justify-between h-16">
            <div className="flex items-center">
              <span className="text-xl font-bold text-teal-700 font-playfair mr-8 hidden md:block">
                Yoga Admin üßò‚Äç‚ôÄÔ∏è
              </span>
              <div className="flex space-x-2 md:space-x-4">
                <button onClick={() => setOngletActif('planning')} className={`px-3 py-2 rounded-md text-sm font-medium transition ${ongletActif === 'planning' ? 'bg-teal-50 text-teal-700' : 'text-gray-500 hover:text-gray-700'}`}>üìÖ Planning</button>
                <button onClick={() => setOngletActif('Annuaire')} className={`px-3 py-2 rounded-md text-sm font-medium transition ${ongletActif === 'Annuaire' ? 'bg-teal-50 text-teal-700' : 'text-gray-500 hover:text-gray-700'}`}>üë• √âl√®ves</button>
              </div>
            </div>
            <div className="flex items-center">
              <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 transition text-sm font-bold border border-gray-200 px-3 py-1 rounded hover:bg-red-50">D√©connexion</button>
            </div>
          </div>
        </div>
      </nav>
      <main className="py-8">
        {ongletActif === 'planning' && <Planning />}
        {ongletActif === 'Annuaire' && <Annuaire />}
      </main>
    </div>
  );
}

export default App;
</file>

<file path="src/GestionGroupes.jsx">
import { useState, useEffect } from 'react';
import { db } from './firebase';
import { collection, addDoc, getDocs, updateDoc, doc, query, where, Timestamp } from 'firebase/firestore';

const JOURS = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];

export default function GestionGroupes({ onClose, onUpdate, initialEditId }) {
    const [groupes, setGroupes] = useState([]);
    const [loading, setLoading] = useState(true);
    const [editingId, setEditingId] = useState(null);

    // --- LOGIQUE DATES PAR D√âFAUT ---
    // Calcule automatiquement une saison "Septembre -> Juin"
    const getDefaultDates = () => {
        const now = new Date();
        // Si on est apr√®s juin, c'est la rentr√©e de cette ann√©e, sinon c'est celle de l'ann√©e d'avant
        const year = now.getMonth() >= 6 ? now.getFullYear() : now.getFullYear() - 1;
        return {
            start: `${year}-09-01`,
            end: `${year + 1}-06-30`
        };
    };

    const [formData, setFormData] = useState({
        nom: '',
        jour: 1, // Lundi par d√©faut
        heureDebut: '18:00',
        duree: 60,
        places: 10,
        actif: true,
        dateDebut: getDefaultDates().start, // NOUVEAU
        dateFin: getDefaultDates().end      // NOUVEAU
    });

    useEffect(() => {
        fetchGroupes();
    }, []);

    useEffect(() => {
        if (initialEditId && groupes.length > 0) {
            const groupToEdit = groupes.find(g => g.id === initialEditId);
            if (groupToEdit) {
                handleEdit(groupToEdit);
            }
        }
    }, [initialEditId, groupes]);


    const fetchGroupes = async () => {
        try {
            const q = query(collection(db, "groupes"), where("actif", "==", true));
            const snap = await getDocs(q);

            const data = snap.docs.map(d => {
                const g = d.data();

                // --- MIGRATION √Ä LA VOL√âE ---
                // Si le groupe n'a pas de dates (vieux groupe), on met des dates par d√©faut pour l'affichage
                let startVal = getDefaultDates().start;
                let endVal = '2030-01-01'; // Date lointaine pour les anciens groupes "infinis"

                if (g.dateDebut && g.dateDebut.toDate) {
                    startVal = g.dateDebut.toDate().toISOString().split('T')[0];
                }
                if (g.dateFin && g.dateFin.toDate) {
                    endVal = g.dateFin.toDate().toISOString().split('T')[0];
                }

                return {
                    id: d.id,
                    ...g,
                    dateDebut: startVal,
                    dateFin: endVal
                };
            });

            // Tri par Jour puis par Heure
            data.sort((a, b) => (a.jour - b.jour) || a.heureDebut.localeCompare(b.heureDebut));
            setGroupes(data);
        } catch (error) {
            console.error("Erreur fetch groupes:", error);
        } finally {
            setLoading(false);
        }
    };

    const resetForm = () => {
        setFormData({
            nom: '', jour: 1, heureDebut: '18:00', duree: 60, places: 10, actif: true,
            dateDebut: getDefaultDates().start,
            dateFin: getDefaultDates().end
        });
        setEditingId(null);
    };

    const handleEdit = (groupe) => {
        setEditingId(groupe.id);
        setFormData({ ...groupe }); // Les dates sont d√©j√† au bon format string gr√¢ce au fetch
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            // Conversion des dates String -> Timestamp Firestore
            const startTs = Timestamp.fromDate(new Date(formData.dateDebut));
            const endTs = Timestamp.fromDate(new Date(formData.dateFin));

            const dataToSave = {
                nom: formData.nom,
                jour: parseInt(formData.jour),
                heureDebut: formData.heureDebut,
                duree: parseInt(formData.duree),
                places: parseInt(formData.places),
                actif: true,
                dateDebut: startTs, // NOUVEAU CHAMP
                dateFin: endTs      // NOUVEAU CHAMP
            };

            if (editingId) {
                await updateDoc(doc(db, "groupes", editingId), dataToSave);
                alert("Cours mis √† jour avec les nouvelles dates !");
            } else {
                await addDoc(collection(db, "groupes"), dataToSave);
                alert("Nouveau cours cr√©√© (avec saisonnalit√©) !");
            }

            resetForm();
            fetchGroupes();
            if (onUpdate) onUpdate(); // Rafra√Æchir le planning derri√®re
        } catch (error) {
            console.error(error);
            alert("Erreur lors de la sauvegarde");
        }
    };

    const handleArchive = async (id, nom) => {
        if (confirm(`Voulez-vous supprimer (archiver) le cours "${nom}" ?`)) {
            try {
                await updateDoc(doc(db, "groupes", id), { actif: false });
                fetchGroupes();
                if (onUpdate) onUpdate();
            } catch (error) {
                console.error(error);
            }
        }
    };

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[90vh]">

                {/* HEADER */}
                <div className="bg-teal-800 p-6 text-white flex justify-between items-center">
                    <div>
                        <h2 className="text-2xl font-bold font-playfair">Gestion des Cours</h2>
                        <p className="text-teal-200 text-sm">D√©finissez les cr√©neaux et leurs p√©riodes d'activit√©.</p>
                    </div>
                    <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl font-bold">‚úï</button>
                </div>

                <div className="flex-1 overflow-y-auto p-6 bg-gray-50 flex flex-col md:flex-row gap-6">

                    {/* COLONNE GAUCHE : FORMULAIRE */}
                    <div className="md:w-1/3 bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                        <h3 className="font-bold text-lg text-teal-800 mb-4 border-b pb-2">
                            {editingId ? "Modification des cours" : "Cr√©er un cours"}
                        </h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Nom du cours</label>
                                <input type="text" required value={formData.nom} onChange={e => setFormData({ ...formData, nom: e.target.value })} className="w-full border p-2 rounded focus:ring-2 focus:ring-teal-500 outline-none" placeholder="ex: Hatha Yoga" />
                            </div>

                            {/* --- NOUVEAUX CHAMPS DATES --- */}
                            <div className="bg-teal-50 p-3 rounded-lg border border-teal-100">
                                <label className="block text-xs font-bold text-teal-800 mb-2 uppercase tracking-wide">üìÖ P√©riode</label>
                                <div className="space-y-3">
                                    <div>
                                        <div className="flex justify-between items-baseline mb-1">
                                            <span className="text-[10px] text-gray-500 uppercase font-bold">D√©but</span>
                                            <span className="text-[10px] text-gray-400 italic">1er cours</span>
                                        </div>
                                        <input type="date" required value={formData.dateDebut} onChange={e => setFormData({ ...formData, dateDebut: e.target.value })} className="w-full border p-1 rounded text-sm bg-white" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between items-baseline mb-1">
                                            <span className="text-[10px] text-gray-500 uppercase font-bold">Fin</span>
                                            <span className="text-[10px] text-gray-400 italic">Dernier cours</span>
                                        </div>
                                        <input type="date" required value={formData.dateFin} onChange={e => setFormData({ ...formData, dateFin: e.target.value })} className="w-full border p-1 rounded text-sm bg-white" />
                                    </div>
                                </div>
                            </div>
                            {/* ----------------------------- */}

                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Jour</label>
                                    <select value={formData.jour} onChange={e => setFormData({ ...formData, jour: e.target.value })} className="w-full border p-2 rounded focus:ring-2 focus:ring-teal-500 outline-none">
                                        {JOURS.map((j, index) => <option key={index} value={index}>{j}</option>)}
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Heure</label>
                                    <input type="time" required value={formData.heureDebut} onChange={e => setFormData({ ...formData, heureDebut: e.target.value })} className="w-full border p-2 rounded focus:ring-2 focus:ring-teal-500 outline-none" />
                                </div>
                            </div>

                            <div className="flex gap-2">
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Dur√©e (min)</label>
                                    <input type="number" required value={formData.duree} onChange={e => setFormData({ ...formData, duree: e.target.value })} className="w-full border p-2 rounded focus:ring-2 focus:ring-teal-500 outline-none" />
                                </div>
                                <div className="flex-1">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Places</label>
                                    <input type="number" required value={formData.places} onChange={e => setFormData({ ...formData, places: e.target.value })} className="w-full border p-2 rounded focus:ring-2 focus:ring-teal-500 outline-none" />
                                </div>
                            </div>

                            <div className="pt-2 flex gap-2">
                                {editingId && (
                                    <button type="button" onClick={resetForm} className="flex-1 px-4 py-2 rounded-lg font-bold text-gray-500 bg-gray-100 hover:bg-gray-200">Annuler</button>
                                )}
                                <button type="submit" className="flex-1 px-4 py-2 rounded-lg font-bold text-white bg-teal-600 hover:bg-teal-700 shadow-md">
                                    {editingId ? "Mettre √† jour" : "Ajouter"}
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* COLONNE DROITE : LISTE */}
                    <div className="md:w-2/3 space-y-3">
                        {loading && <p>Chargement...</p>}
                        {!loading && groupes.length === 0 && <p className="text-gray-500 italic">Aucun cours r√©current configur√©.</p>}

                        {groupes.map(g => (
                            <div key={g.id} className={`bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center transition ${editingId === g.id ? 'ring-2 ring-teal-500 bg-teal-50' : 'hover:shadow-md'}`}>
                                <div className="flex items-center gap-4">
                                    <div className="bg-teal-100 text-teal-800 font-bold w-12 h-12 rounded-lg flex flex-col items-center justify-center text-xs leading-tight">
                                        <span className="text-lg">{g.heureDebut.split(':')[0]}</span>
                                        <span>{g.heureDebut.split(':')[1]}</span>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-gray-800 flex items-center gap-2">
                                            {g.nom}
                                        </h4>
                                        <div className="text-sm text-gray-500 flex flex-wrap gap-x-2 items-center mt-1">
                                            <span className="font-semibold text-teal-600 uppercase text-xs">{JOURS[g.jour]}</span>
                                            <span className="text-gray-300">‚Ä¢</span>

                                            {/* Affichage visuel des dates */}
                                            <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded border border-gray-200">
                                                {new Date(g.dateDebut).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' })}
                                                {' ‚ûú '}
                                                {new Date(g.dateFin).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' })}
                                            </span>

                                            <span className="text-gray-300 hidden md:inline">‚Ä¢</span>
                                            <span className="hidden md:inline">{g.places} pl.</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => handleEdit(g)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Modifier">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onClick={() => handleArchive(g.id, g.nom)} className="p-2 text-red-600 hover:bg-red-50 rounded-full transition" title="Supprimer (Archiver)">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/Home.jsx">
import React from 'react';
import { Link } from 'react-router-dom';

export default function Home() {
    return (
        <div className="min-h-screen bg-stone-50 font-sans text-gray-800">

            {/* --- HERO SECTION (En-t√™te) --- */}
            <header className="bg-white shadow-sm border-b border-stone-100">
                <div className="max-w-5xl mx-auto px-4 py-6 md:py-8 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div className="flex items-center gap-4">
                        {/* LOGO */}
                        <img src="/logo.jpg" alt="Logo Natur'Veda" className="w-20 h-20 md:w-24 md:h-24 object-contain rounded-full border-2 border-teal-50 shadow-sm" />
                        <div>
                            <h1 className="text-3xl md:text-4xl font-playfair font-bold text-teal-900 leading-tight">
                                Natur‚ÄôVeda
                            </h1>
                            <p className="text-amber-700 font-medium tracking-widest text-sm uppercase mt-1">Yoga ‚Ä¢ M√©ditation ‚Ä¢ Ayurv√©da</p>
                        </div>
                    </div>
                    <div className="text-center md:text-right">
                        <p className="text-xl md:text-2xl font-playfair italic text-gray-600">"Respirez. Pratiquez. √âvoluez."</p>
                    </div>
                </div>
            </header>

            {/* --- SECTION ACC√àS APPLICATION --- */}
            <section className="pt-8 px-4">
                <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden border border-teal-100">
                    <div className="bg-teal-50 p-6 text-center border-b border-teal-100">
                        <h2 className="text-2xl font-bold text-teal-900 font-playfair mb-3">Espace Membre</h2>
                        <div className="text-teal-800 text-sm md:text-base max-w-2xl mx-auto font-medium space-y-2">
                            <p>
                                Vos cours de Yoga, simplifi√©s. Consultez votre planning, vos cr√©dits et votre progression.
                            </p>
                            <p>
                                <span className="font-bold">Cours complet ?</span> Mettez-vous en attente pour recevoir une alerte en cas de d√©sistement.
                            </p>
                        </div>
                    </div>

                    <div className="p-6 md:p-8 flex flex-col md:flex-row justify-center items-center gap-4 md:gap-6 bg-white">
                        {/* Bouton √âl√®ve : Ton adouci (Amber-600 au lieu de 700) */}
                        <Link to="/student" className="w-full md:w-auto px-8 py-3 bg-[#c27a4e] hover:bg-[#a8653e] text-white rounded-xl font-bold text-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5 text-center flex items-center justify-center gap-2">
                            üßò‚Äç‚ôÄÔ∏è Acc√®s √âl√®ve
                        </Link>
                        {/* Bouton Prof */}
                        <Link to="/admin" className="w-full md:w-auto px-8 py-3 bg-white border-2 border-teal-800 text-teal-900 hover:bg-teal-50 rounded-xl font-bold text-lg shadow-sm hover:shadow-md transition text-center flex items-center justify-center gap-2">
                            üîí Acc√®s Professeur
                        </Link>
                    </div>
                </div>
            </section>

            {/* --- NOUVELLE SECTION : AUDIO / M√âDITATION --- */}
            <section className="py-8 px-4">
                <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg border-l-8 border-amber-400 overflow-hidden flex flex-col md:flex-row items-center p-6 gap-6 hover:shadow-xl transition-shadow">

                    {/* Ic√¥ne Casque + Lotus */}
                    <div className="shrink-0 text-amber-600">
                        <svg width="80" height="80" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            {/* Arceau du casque */}
                            <path d="M20 50V40C20 23.4315 33.4315 10 50 10C66.5685 10 80 23.4315 80 40V50" stroke="currentColor" strokeWidth="4" strokeLinecap="round" />
                            {/* √âcouteurs */}
                            <rect x="10" y="50" width="20" height="30" rx="5" fill="currentColor" opacity="0.1" stroke="currentColor" strokeWidth="3" />
                            <rect x="70" y="50" width="20" height="30" rx="5" fill="currentColor" opacity="0.1" stroke="currentColor" strokeWidth="3" />
                            {/* Lotus stylis√© sur l'arceau */}
                            <path d="M50 10C50 10 45 20 35 20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                            <path d="M50 10C50 10 55 20 65 20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                            <circle cx="50" cy="10" r="4" fill="currentColor" />
                            {/* Petite lune */}
                            <path d="M50 25C47 25 45 23 45 23C45 26 47 28 50 28C53 28 55 26 55 23C55 23 53 25 50 25Z" fill="currentColor" />
                        </svg>
                    </div>

                    <div className="text-center md:text-left flex-1">

                        <p className="text-gray-600 my-2 text-sm md:text-base leading-relaxed">
                            Vous pensez ne pas savoir m√©diter ? D√©couvrez la porte d'entr√©e la plus accessible vers l'√©tat m√©ditatif.
                        </p>
                        <a
                            href="https://www.ayurvedayoganidra.com/category/4-packs"
                            target="_blank"
                            rel="noreferrer"
                            className="inline-flex items-center gap-2 mt-2 text-amber-700 font-bold hover:text-amber-800 hover:underline uppercase tracking-wide text-sm"
                        >
                            D√©couvrir mes audios
                          
                        </a>
                    </div>
                </div>
            </section>

            {/* --- SECTION PR√âSENTATION PROFESSEUR --- */}
            <section className="pb-12 px-4 max-w-5xl mx-auto">
                <div className="grid md:grid-cols-12 gap-8 items-start">

                    {/* Colonne Gauche : Enseignements */}
                    <div className="md:col-span-8 space-y-8">
                        <div>
                            <h3 className="text-2xl font-playfair font-bold text-teal-800 mb-6 mt-0 border-b-2 border-amber-200 inline-block pb-1">
                                Enseignements & Pratiques
                            </h3>

                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="bg-white p-5 rounded-lg shadow-sm border-l-4 border-teal-600">
                                    <h4 className="font-bold text-lg mb-3 text-teal-900">Professeur de Yoga</h4>
                                    <ul className="space-y-1 text-gray-600 text-sm md:text-base">
                                        <li>‚Ä¢ HATHA Yoga</li>
                                        <li>‚Ä¢ Yoga IYENGAR</li>
                                        <li>‚Ä¢ YIN Yoga</li>
                                        <li>‚Ä¢ GREEN Yoga</li>
                                        <li>‚Ä¢ VINYASA Yoga</li>
                                        <li>‚Ä¢ Mantra Yoga</li>
                                    </ul>
                                </div>

                                <div className="bg-white p-5 rounded-lg shadow-sm border-l-4 border-amber-600">
                                    <h4 className="font-bold text-lg mb-3 text-amber-900">Approfondissement</h4>
                                    <ul className="space-y-1 text-gray-600 text-sm md:text-base">
                                        <li>‚Ä¢ Pranayama (Respiration)</li>
                                        <li>‚Ä¢ M√©ditation</li>
                                        <li>‚Ä¢ <strong>Yoga Nidra</strong> (Professeur & Instructeur)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 className="font-bold text-teal-800 mb-3 uppercase tracking-wide text-xs">Th√©rapies & Soins</h4>
                                <ul className="bg-teal-50 p-4 rounded-lg text-teal-900 space-y-2 font-medium text-sm">
                                    <li>üåø Th√©rapeute en Ayurveda</li>
                                    <li>üå∏ Praticienne en Aromath√©rapie</li>
                                </ul>
                            </div>
                            <div>
                                <h4 className="font-bold text-amber-800 mb-3 uppercase tracking-wide text-xs">Textes Anciens & Sacr√©s</h4>
                                <ul className="bg-amber-50 p-4 rounded-lg text-amber-900 space-y-2 font-medium text-sm">
                                    <li>üìú SanƒÅtana Dharma</li>
                                    <li>üìú Yoga Sutra</li>
                                    <li>üìú Bhagavad Gƒ´ta</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    {/* Colonne Droite : Carte de visite / Contact */}
                    <div className="md:col-span-4 bg-white p-6 rounded-xl shadow-lg border border-stone-200 sticky top-4">
                        <div className="text-center mb-6">
                            <div className="w-16 h-1 bg-amber-600 mx-auto mb-4 rounded-full"></div>
                            <h3 className="text-xl font-bold text-gray-800">Sandrine PUTOD</h3>
                            <p className="text-teal-700 italic text-sm">Fondatrice Natur'Veda</p>
                        </div>

                        <div className="space-y-4 text-sm text-gray-600">
                            <div className="flex items-start gap-3">
                                <span className="text-xl">üìç</span>
                                <p>
                                    <strong>8, rue des fr√™nes</strong><br />
                                    (entr√©e par le portail blanc)<br />
                                    39250 MIGNOVILLARD
                                </p>
                            </div>

                            <div className="flex items-center gap-3">
                                <span className="text-xl">üìû</span>
                                <a href="tel:0781108075" className="font-bold text-gray-800 hover:text-amber-700 transition">07 81 10 80 75</a>
                            </div>

                            <div className="flex items-center gap-3">
                                <span className="text-xl">üìß</span>
                                <a href="mailto:putod.sandrine@gmail.com" className="hover:text-amber-700 transition truncate">putod.sandrine@gmail.com</a>
                            </div>

                            <div className="flex items-center gap-3">
                                <span className="text-xl">üåê</span>
                                <a href="https://www.ayurvedayoganidra.com" target="_blank" rel="noreferrer" className="text-teal-700 font-medium hover:underline hover:text-teal-900">
                                    www.ayurvedayoganidra.com
                                </a>
                            </div>
                        </div>

                        <div className="mt-6 pt-6 border-t border-gray-100 flex justify-center gap-4">
                            <a href="https://www.facebook.com/AYURVEDAYOGANIDRA" target="_blank" rel="noreferrer" className="bg-[#1877F2] text-white p-2.5 rounded-full hover:bg-blue-700 transition flex items-center justify-center shadow-sm" title="Facebook">
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 fill-current" viewBox="0 0 24 24">
                                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
                                </svg>
                            </a>
                            <a href="https://www.instagram.com/naturveda.yoganidra/?hl=fr" target="_blank" rel="noreferrer" className="bg-[#E4405F] text-white p-2.5 rounded-full hover:bg-pink-700 transition flex items-center justify-center shadow-sm" title="Instagram">
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 fill-current" viewBox="0 0 24 24">
                                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.012 3.584-.07 4.85c-.148 3.252-1.691 4.771-4.919 4.919-1.265.058-1.645.069-4.85.069s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.012-3.584.07-4.85c.148-3.252 1.691-4.771 4.919-4.919 1.265-.058 1.645-.069 4.85-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                                </svg>
                            </a>
                        </div>
                    </div>

                </div>
            </section>

            {/* --- FOOTER --- */}
            <footer className="bg-stone-800 text-stone-400 py-8 text-center text-sm">
                <p>&copy; {new Date().getFullYear()} Natur'Veda - Sandrine Putod.</p>
                <p className="mt-2 text-xs opacity-50">Respirez. Pratiquez. √âvoluez.</p>
            </footer>
        </div>
    );
}
</file>

<file path="src/annuaire.jsx">
import { useState, useEffect } from 'react';
import { db } from './firebase';
import { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, orderBy, query, serverTimestamp, arrayUnion } from 'firebase/firestore';
import toast from 'react-hot-toast';
import ConfirmModal from './components/ConfirmModal';

export default function Annuaire() {
    // --- √âTATS ---
    const [eleves, setEleves] = useState([]);
    const [groupes, setGroupes] = useState([]);
    const [loading, setLoading] = useState(true);

    // Recherche & Filtres
    const [searchTerm, setSearchTerm] = useState("");
    const [selectedGroupId, setSelectedGroupId] = useState(""); 
    const [paymentFilter, setPaymentFilter] = useState("all"); // 'all', 'ok', 'todo'
    const [showArchived, setShowArchived] = useState(false);

    // Inscription Rapide
    const [showEnrollModal, setShowEnrollModal] = useState(false);
    const [enrollSearch, setEnrollSearch] = useState("");

    // √âdition
    const [formData, setFormData] = useState({ nom: '', prenom: '', email: '' });
    const [eleveEnEdition, setEleveEnEdition] = useState(null);
    const [editCredits, setEditCredits] = useState(0);
    const [activeTab, setActiveTab] = useState('details'); 
    
    // Historique
    const [history, setHistory] = useState([]);
    const [loadingHistory, setLoadingHistory] = useState(false);

    // Modale de confirmation
    const [confirmConfig, setConfirmConfig] = useState(null);

    const JOURS = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];

    useEffect(() => {
        fetchData();
    }, []);

    // --- FONCTIONS UTILITAIRES ---

    const isGroupActive = (groupe) => {
        if (!groupe || !groupe._fin) return false;
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1); 
        return groupe._fin >= yesterday;
    };

    const sortGroupsLogic = (a, b) => {
        const aActive = isGroupActive(a);
        const bActive = isGroupActive(b);
        if (aActive && !bActive) return -1;
        if (!aActive && bActive) return 1;

        const getDayIndex = (d) => (d === 0 ? 7 : d);
        const dayDiff = getDayIndex(a.jour) - getDayIndex(b.jour);
        if (dayDiff !== 0) return dayDiff;

        return a.heureDebut.localeCompare(b.heureDebut);
    };

    const fetchData = async () => {
        try {
            setLoading(true);

            // 1. Charger √âl√®ves
            const qEleves = query(collection(db, "eleves"), orderBy("nom"));
            const snapshotEleves = await getDocs(qEleves);
            setEleves(snapshotEleves.docs.map(doc => ({ id: doc.id, ...doc.data() })));

            // 2. Charger Groupes
            const snapshotGroupes = await getDocs(collection(db, "groupes"));
            const dataGroupes = snapshotGroupes.docs.map(doc => {
                const d = doc.data();
                const debut = d.dateDebut?.toDate ? d.dateDebut.toDate() : new Date('2024-01-01');
                const fin = d.dateFin?.toDate ? d.dateFin.toDate() : new Date('2030-01-01');
                return { id: doc.id, ...d, _debut: debut, _fin: fin };
            });

            dataGroupes.sort(sortGroupsLogic);
            setGroupes(dataGroupes);
        } catch (error) {
            console.error(error);
            toast.error("Erreur de chargement des donn√©es");
        } finally {
            setLoading(false);
        }
    };

    const fetchHistory = async (eleveId) => {
        setLoadingHistory(true);
        try {
            const q = query(collection(db, "eleves", eleveId, "history"), orderBy("date", "desc"));
            const snapshot = await getDocs(q);
            setHistory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        } catch (error) {
            console.error("Erreur historique:", error);
            toast.error("Impossible de charger l'historique");
        } finally {
            setLoadingHistory(false);
        }
    };

    // --- LOGIQUE PAIEMENT ---
    
    const togglePaymentStatus = async (eleveId, groupeId, currentStatus) => {
        // Optimiste UI update
        const newStatus = !currentStatus;
        
        setEleves(prev => prev.map(e => {
            if (e.id === eleveId) {
                const newPayments = { ...(e.payments || {}), [groupeId]: newStatus };
                return { ...e, payments: newPayments };
            }
            return e;
        }));

        try {
            await updateDoc(doc(db, "eleves", eleveId), {
                [`payments.${groupeId}`]: newStatus
            });
            toast.success(newStatus ? "Marqu√© comme PAY√â" : "Marqu√© comme NON PAY√â", { duration: 1500, icon: newStatus ? '‚úÖ' : '‚ùå' });
        } catch (error) {
            console.error(error);
            toast.error("Erreur sauvegarde paiement");
            fetchData(); // Revert en cas d'erreur
        }
    };

    // --- ACTIONS ---

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.nom || !formData.prenom) return;

        const toastId = toast.loading("Cr√©ation...");
        try {
            await addDoc(collection(db, "eleves"), {
                nom: formData.nom.toUpperCase(),
                prenom: formData.prenom,
                email: formData.email.trim().toLowerCase(),
                role: "student",
                absARemplacer: 0,
                enrolledGroupIds: [],
                payments: {} // Init payments map
            });
            setFormData({ nom: '', prenom: '', email: '' });
            fetchData();
            toast.success("√âl√®ve cr√©√© avec succ√®s !", { id: toastId });
        } catch (error) {
            console.error(error);
            toast.error("Erreur lors de la cr√©ation", { id: toastId });
        }
    };

    const demanderSuppression = (id, nomComplet) => {
        setConfirmConfig({
            title: "Supprimer l'√©l√®ve ?",
            content: (
                <div>
                    <p>√ätes-vous s√ªr de vouloir supprimer d√©finitivement <strong>{nomComplet}</strong> ?</p>
                    <p className="text-xs text-red-500 mt-2 font-bold">Cette action est irr√©versible.</p>
                </div>
            ),
            confirmLabel: "Supprimer d√©finitivement",
            colorClass: "bg-red-600",
            onConfirm: async () => {
                try {
                    await deleteDoc(doc(db, "eleves", id));
                    setEleves(prev => prev.filter(e => e.id !== id));
                    toast.success("√âl√®ve supprim√©.");
                    setConfirmConfig(null);
                } catch (error) {
                    console.error(error);
                    toast.error("Erreur lors de la suppression");
                }
            }
        });
    };

    const deleteHistoryItem = async (historyId) => {
        if (!confirm("Supprimer cette ligne d'historique ? Cela n'impactera pas le solde actuel, c'est juste visuel.")) return;
        try {
            await deleteDoc(doc(db, "eleves", eleveEnEdition.id, "history", historyId));
            setHistory(prev => prev.filter(h => h.id !== historyId));
            toast.success("Ligne supprim√©e");
        } catch (e) {
            console.error(e);
            toast.error("Erreur suppression historique");
        }
    };

    // --- ACTIONS D'INSCRIPTION RAPIDE ---

    const handleEnrollStudent = async (studentId) => {
        if (!selectedGroupId) return;
        const student = eleves.find(e => e.id === studentId);
        const group = groupes.find(g => g.id === selectedGroupId);
        
        if (!student || !group) return;

        const toastId = toast.loading(`Inscription de ${student.prenom}...`);
        try {
            await updateDoc(doc(db, "eleves", studentId), {
                enrolledGroupIds: arrayUnion(selectedGroupId)
            });
            
            // Mise √† jour locale
            setEleves(prev => prev.map(e => {
                if (e.id === studentId) {
                    const currentGroups = e.enrolledGroupIds || [];
                    return { ...e, enrolledGroupIds: [...currentGroups, selectedGroupId] };
                }
                return e;
            }));

            toast.success(`${student.prenom} inscrit au cours !`, { id: toastId });
        } catch (error) {
            console.error(error);
            toast.error("Erreur lors de l'inscription", { id: toastId });
        }
    };

    // --- LOGIQUE MODALE √âDITION ---

    const openEditModal = (eleve) => {
        setEleveEnEdition(eleve);
        setEditCredits(eleve.absARemplacer || 0);
        setActiveTab('details'); 
        fetchHistory(eleve.id);
    };

    const toggleGroupePourEleve = (groupeId) => {
        if (!eleveEnEdition) return;
        const currentGroups = eleveEnEdition.enrolledGroupIds || [];
        let newGroups;
        if (currentGroups.includes(groupeId)) {
            newGroups = currentGroups.filter(id => id !== groupeId);
        } else {
            newGroups = [...currentGroups, groupeId];
        }
        setEleveEnEdition({ ...eleveEnEdition, enrolledGroupIds: newGroups });
    };

    const sauvegarderEdition = async () => {
        const toastId = toast.loading("Sauvegarde...");
        try {
            const userRef = doc(db, "eleves", eleveEnEdition.id);
            const nouveauxCredits = parseInt(editCredits);
            const anciensCredits = eleveEnEdition.absARemplacer || 0;
            const delta = nouveauxCredits - anciensCredits;

            await updateDoc(userRef, {
                nom: eleveEnEdition.nom.toUpperCase(),
                prenom: eleveEnEdition.prenom,
                email: eleveEnEdition.email.trim().toLowerCase(),
                enrolledGroupIds: eleveEnEdition.enrolledGroupIds,
                absARemplacer: nouveauxCredits
            });

            if (delta !== 0) {
                await addDoc(collection(db, "eleves", eleveEnEdition.id, "history"), {
                    date: serverTimestamp(),
                    delta: delta,
                    motif: "R√©gularisation Admin",
                    seanceId: "admin_manual",
                    groupeNom: "-",
                    seanceDate: new Date().toLocaleDateString('fr-FR')
                });
            }

            toast.success("Modifications enregistr√©es !", { id: toastId });
            setEleveEnEdition(null);
            fetchData();
        } catch (error) {
            console.error(error);
            toast.error("Erreur lors de la sauvegarde", { id: toastId });
        }
    };

    // --- FILTRAGE FINAL ---
    const filteredEleves = eleves.filter(e => {
        const matchesSearch = (e.nom + ' ' + e.prenom).toLowerCase().includes(searchTerm.toLowerCase());
        const matchesGroup = selectedGroupId === "" || (e.enrolledGroupIds && e.enrolledGroupIds.includes(selectedGroupId));
        
        let matchesPayment = true;
        if (paymentFilter !== 'all') {
            const userGroups = e.enrolledGroupIds || [];
            // Si pas de groupe, on consid√®re "√† jour" (pas de dette) mais on peut l'exclure si on veut
            if (userGroups.length === 0) {
                matchesPayment = (paymentFilter === 'ok'); // Visible seulement si on cherche "ok"
            } else {
                const allPaid = userGroups.every(gid => e.payments?.[gid] === true);
                if (paymentFilter === 'ok') matchesPayment = allPaid;
                if (paymentFilter === 'todo') matchesPayment = !allPaid;
            }
        }

        return matchesSearch && matchesGroup && matchesPayment;
    });

    // --- PREPARATION LISTE MODALE INSCRIPTION ---
    const selectedGroupObj = groupes.find(g => g.id === selectedGroupId);
    const eligibleStudentsForEnrollment = eleves.filter(e => {
        // Recherche dans la modale
        const matchesModalSearch = (e.nom + ' ' + e.prenom).toLowerCase().includes(enrollSearch.toLowerCase());
        // Pas d√©j√† inscrit dans ce groupe
        const notAlreadyIn = !(e.enrolledGroupIds && e.enrolledGroupIds.includes(selectedGroupId));
        return matchesModalSearch && notAlreadyIn;
    });


    return (
        <div className="max-w-6xl mx-auto p-4 relative">
            
            <ConfirmModal
                isOpen={!!confirmConfig}
                title={confirmConfig?.title}
                confirmLabel={confirmConfig?.confirmLabel}
                colorClass={confirmConfig?.colorClass}
                onConfirm={confirmConfig?.onConfirm}
                onCancel={() => setConfirmConfig(null)}
            >
                {confirmConfig?.content}
            </ConfirmModal>

            {/* HEADER ET OUTILS DE FILTRE */}
            <div className="flex flex-col gap-6 mb-8 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <div className="flex justify-between items-center border-b border-gray-100 pb-4">
                    <h2 className="text-2xl font-playfair font-bold text-teal-900">
                        Annuaire √âl√®ves ({filteredEleves.length})
                    </h2>
                    
                    {/* TOGGLE ARCHIVES */}
                    <div className="flex items-center bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200 hover:bg-white transition cursor-pointer" onClick={() => setShowArchived(!showArchived)}>
                        <span className="text-xs font-bold text-gray-600 mr-2 select-none">
                            Voir cours termin√©s
                        </span>
                        <div className={`relative w-10 h-5 rounded-full transition duration-200 ease-in-out ${showArchived ? 'bg-teal-500' : 'bg-gray-300'}`}>
                            <div className={`absolute left-0.5 top-0.5 bg-white w-4 h-4 rounded-full shadow-md transform transition duration-200 ease-in-out ${showArchived ? 'translate-x-5' : 'translate-x-0'}`}></div>
                        </div>
                    </div>
                </div>

                <div className="flex flex-col md:flex-row gap-4 items-end md:items-center justify-between">
                    {/* BARRE DE RECHERCHE NOM */}
                    <div className="relative w-full md:w-1/3">
                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                        <input
                            type="text"
                            placeholder="Rechercher nom ou pr√©nom..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none text-sm shadow-sm"
                        />
                    </div>

                    {/* S√âLECTEUR DE GROUPE */}
                    <div className="relative w-full md:w-1/2 flex gap-2 items-end">
                        <div className="flex-1">
                            <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Filtrer par Groupe</label>
                            <select
                                value={selectedGroupId}
                                onChange={(e) => setSelectedGroupId(e.target.value)}
                                className={`w-full border py-2 px-3 rounded-lg text-sm font-medium outline-none focus:ring-2 focus:ring-teal-500 shadow-sm transition ${selectedGroupId ? 'bg-purple-50 text-purple-900 border-purple-300' : 'bg-white text-gray-600'}`}
                            >
                                <option value="">-- Tous les √©l√®ves --</option>
                                {groupes.map(g => {
                                    const active = isGroupActive(g);
                                    return (
                                        <option key={g.id} value={g.id} className={!active ? 'text-gray-400' : 'text-gray-900 font-bold'}>
                                            {active ? "üü¢" : "üí§"} {JOURS[g.jour]} {g.heureDebut} - {g.nom}
                                        </option>
                                    );
                                })}
                            </select>
                        </div>

                         {/* NOUVEAU : FILTRE PAIEMENT */}
                         <div>
                            <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Paiement</label>
                            <select
                                value={paymentFilter}
                                onChange={(e) => setPaymentFilter(e.target.value)}
                                className={`border py-2 px-3 rounded-lg text-sm font-bold outline-none focus:ring-2 shadow-sm transition h-[38px] ${paymentFilter === 'todo' ? 'bg-red-50 text-red-600 border-red-200' : (paymentFilter === 'ok' ? 'bg-teal-50 text-teal-600 border-teal-200' : 'bg-white text-gray-600 border-gray-200')}`}
                            >
                                <option value="all">Tout</option>
                                <option value="ok">‚úÖ √Ä jour</option>
                                <option value="todo">‚ùå Impay√©s</option>
                            </select>
                        </div>

                        {/* BOUTON AJOUT RAPIDE AU GROUPE */}
                        {selectedGroupId && (
                            <button 
                                onClick={() => { setEnrollSearch(""); setShowEnrollModal(true); }}
                                className="bg-purple-600 text-white px-3 py-2 rounded-lg font-bold text-sm hover:bg-purple-700 shadow-md transition flex items-center gap-1 h-[38px] whitespace-nowrap"
                                title="Ajouter un √©l√®ve existant √† ce cours"
                            >
                                üë§+ Inscrire
                            </button>
                        )}
                    </div>
                </div>
            </div>

            {/* FORMULAIRE CR√âATION √âL√àVE */}
            <div className="bg-white p-4 rounded-xl shadow-sm mb-8 border border-gray-100">
                 <h3 className="font-bold text-sm text-teal-800 uppercase tracking-wide mb-3">Cr√©er un nouvel √©l√®ve</h3>
                 <form onSubmit={handleSubmit} className="flex flex-col md:flex-row gap-3 items-end">
                    <div className="flex-1 w-full">
                        <label className="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">Nom</label>
                        <input type="text" placeholder="DUPONT" value={formData.nom} onChange={e => setFormData({ ...formData, nom: e.target.value })} className="w-full border p-2 rounded uppercase text-sm focus:ring-2 focus:ring-teal-500 outline-none" required />
                    </div>
                    <div className="flex-1 w-full">
                        <label className="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">Pr√©nom</label>
                        <input type="text" placeholder="Marie" value={formData.prenom} onChange={e => setFormData({ ...formData, prenom: e.target.value })} className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-teal-500 outline-none" required />
                    </div>
                    <div className="flex-1 w-full">
                        <label className="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">Email</label>
                        <input type="email" placeholder="marie@mail.com" value={formData.email} onChange={e => setFormData({ ...formData, email: e.target.value })} className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-teal-500 outline-none" />
                    </div>
                    <button type="submit" className="bg-teal-700 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-teal-800 shadow-sm transition h-[38px] flex items-center gap-2">
                        <span>+</span> Cr√©er
                    </button>
                </form>
            </div>

            {/* TABLEAU LISTE */}
            <div className="bg-white rounded-xl shadow overflow-hidden border border-gray-200">
                {loading ? (
                    <div className="p-10 text-center text-gray-500 font-medium">Chargement de l'annuaire...</div>
                ) : filteredEleves.length === 0 ? (
                    <div className="p-10 text-center text-gray-400 italic">
                        Aucun √©l√®ve ne correspond √† vos crit√®res.
                    </div>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-gray-50 text-gray-600 uppercase text-xs tracking-wider">
                                <tr>
                                    <th className="p-4 border-b w-1/4">Identit√©</th>
                                    <th className="p-4 border-b w-1/2">Groupes inscrits & Paiement</th>
                                    <th className="p-4 border-b text-center">Cr√©dits</th>
                                    <th className="p-4 border-b text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {filteredEleves.map(eleve => {
                                    const rawGroups = (eleve.enrolledGroupIds || [])
                                        .map(gid => groupes.find(g => g.id === gid))
                                        .filter(Boolean);

                                    const activeGroups = rawGroups.filter(g => isGroupActive(g)).sort(sortGroupsLogic);
                                    const finishedGroups = rawGroups.filter(g => !isGroupActive(g)).sort(sortGroupsLogic);

                                    const displayGroups = showArchived 
                                        ? [...activeGroups, ...finishedGroups] 
                                        : activeGroups;

                                    return (
                                        <tr key={eleve.id} className="hover:bg-gray-50 group transition-colors">
                                            <td className="p-4 align-top">
                                                <div className="font-bold text-gray-800">{eleve.nom} {eleve.prenom}</div>
                                                <div className="text-gray-400 text-xs mt-0.5">{eleve.email}</div>
                                            </td>
                                            <td className="p-4 text-sm text-gray-600 align-top">
                                                <div className="flex flex-wrap gap-2">
                                                    {displayGroups.length > 0 ? (
                                                        displayGroups.map(g => {
                                                            const active = isGroupActive(g);
                                                            const isPaid = eleve.payments?.[g.id] === true;
                                                            return (
                                                                <div key={g.id} className="flex items-center">
                                                                    <span 
                                                                        className={`px-2 py-1 rounded-l-md text-xs font-bold border-t border-b border-l whitespace-nowrap flex items-center gap-1 transition-colors h-[26px]
                                                                        ${active 
                                                                            ? 'bg-teal-50 text-teal-800 border-teal-200' 
                                                                            : 'bg-gray-100 text-gray-400 border-gray-200 grayscale'}`}
                                                                        title={!active ? "Cours termin√©" : "Cours actif"}
                                                                    >
                                                                        {!active && <span className="text-[10px]">üö´</span>}
                                                                        {g.nom} ‚Ä¢ {JOURS[g.jour]} {g.heureDebut}
                                                                    </span>
                                                                    {/* TOGGLE PAIEMENT */}
                                                                    <button 
                                                                        onClick={() => togglePaymentStatus(eleve.id, g.id, isPaid)}
                                                                        className={`px-2 py-1 rounded-r-md text-[10px] font-bold border-t border-b border-r h-[26px] transition-all hover:brightness-110 active:scale-95
                                                                        ${isPaid 
                                                                            ? 'bg-green-500 text-white border-green-600' 
                                                                            : 'bg-red-500 text-white border-red-600'}`}
                                                                        title={isPaid ? "Marquer comme non pay√©" : "Marquer comme pay√©"}
                                                                    >
                                                                        {isPaid ? "‚Ç¨ OK" : "‚Ç¨ --"}
                                                                    </button>
                                                                </div>
                                                            )
                                                        })
                                                    ) : (
                                                        <span className="text-gray-400 italic text-xs py-1">Aucun groupe actif.</span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="p-4 text-center align-middle">
                                                <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold shadow-sm ${eleve.absARemplacer > 0 ? 'bg-purple-100 text-purple-700' : (eleve.absARemplacer < 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-500')}`}>
                                                    {eleve.absARemplacer > 0 ? '+' : ''}{eleve.absARemplacer}
                                                </span>
                                            </td>
                                            <td className="p-4 text-right align-middle">
                                                <div className="flex items-center justify-end gap-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => openEditModal(eleve)} className="bg-white hover:bg-blue-50 text-gray-400 hover:text-blue-600 border border-gray-200 hover:border-blue-200 p-2 rounded-lg transition shadow-sm" title="√âditer">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button onClick={() => demanderSuppression(eleve.id, `${eleve.prenom} ${eleve.nom}`)} className="bg-white hover:bg-red-50 text-gray-400 hover:text-red-600 border border-gray-200 hover:border-red-200 p-2 rounded-lg transition shadow-sm" title="Supprimer">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>

            {/* MODALE D'INSCRIPTION RAPIDE */}
            {showEnrollModal && (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" onClick={() => setShowEnrollModal(false)}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in-95" onClick={e => e.stopPropagation()}>
                        <div className="bg-purple-700 p-4 text-white flex justify-between items-center">
                            <div>
                                <h3 className="font-bold font-playfair text-lg">Inscrire un √©l√®ve</h3>
                                <p className="text-purple-200 text-xs">Groupe : {selectedGroupObj?.nom}</p>
                            </div>
                            <button onClick={() => setShowEnrollModal(false)} className="text-white/60 hover:text-white font-bold">‚úï</button>
                        </div>
                        <div className="p-4">
                            <input 
                                type="text" 
                                autoFocus
                                placeholder="üîç Chercher un √©l√®ve..." 
                                value={enrollSearch}
                                onChange={e => setEnrollSearch(e.target.value)}
                                className="w-full border p-2 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500 outline-none"
                            />
                            <div className="max-h-64 overflow-y-auto border rounded-lg divide-y divide-gray-100">
                                {eligibleStudentsForEnrollment.length === 0 ? (
                                    <div className="p-4 text-center text-gray-400 text-sm italic">Aucun √©l√®ve trouv√© (ou d√©j√† inscrit).</div>
                                ) : (
                                    eligibleStudentsForEnrollment.map(eleve => (
                                        <div key={eleve.id} className="p-3 hover:bg-purple-50 flex justify-between items-center group cursor-pointer" onClick={() => handleEnrollStudent(eleve.id)}>
                                            <div>
                                                <div className="font-bold text-gray-800 text-sm">{eleve.nom} {eleve.prenom}</div>
                                                <div className="text-xs text-gray-400">{eleve.email}</div>
                                            </div>
                                            <button className="bg-white text-purple-600 border border-purple-200 px-3 py-1 rounded text-xs font-bold group-hover:bg-purple-600 group-hover:text-white transition">
                                                Ajouter
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* MODALE D'√âDITION COMPLETE */}
            {eleveEnEdition && (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm" onClick={() => setEleveEnEdition(null)}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95" onClick={e => e.stopPropagation()}>
                        
                        {/* HEADER MODAL */}
                        <div className="bg-gradient-to-r from-teal-800 to-teal-700 p-5 text-white flex justify-between items-center relative shadow-md shrink-0">
                            <div>
                                <h3 className="text-xl font-bold font-playfair flex items-center gap-2">
                                    <span>üë§</span> √âdition √âl√®ve
                                </h3>
                                <p className="text-teal-100 text-sm mt-0.5">{eleveEnEdition.prenom} {eleveEnEdition.nom}</p>
                            </div>
                            <button onClick={() => setEleveEnEdition(null)} className="bg-white/20 hover:bg-white/30 text-white rounded-full w-8 h-8 flex items-center justify-center transition">‚úï</button>
                        </div>

                        {/* ONGLETS DE NAVIGATION */}
                        <div className="flex border-b border-gray-200 bg-gray-50 shrink-0">
                            <button 
                                onClick={() => setActiveTab('details')} 
                                className={`flex-1 py-3 font-bold text-sm transition border-b-2 ${activeTab === 'details' ? 'text-teal-800 border-teal-800 bg-white' : 'text-gray-500 border-transparent hover:text-gray-700'}`}
                            >
                                üë§ D√©tails & Groupes
                            </button>
                            <button 
                                onClick={() => setActiveTab('history')} 
                                className={`flex-1 py-3 font-bold text-sm transition border-b-2 ${activeTab === 'history' ? 'text-teal-800 border-teal-800 bg-white' : 'text-gray-500 border-transparent hover:text-gray-700'}`}
                            >
                                üìú Historique
                            </button>
                        </div>

                        {/* CONTENU SCROLLABLE */}
                        <div className="p-6 overflow-y-auto bg-gray-50/50 flex-1 space-y-6">
                            
                            {/* --- ONGLET DETAILS --- */}
                            {activeTab === 'details' && (
                                <>
                                    {/* BLOC 1: INFOS */}
                                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                                        <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 border-b pb-2 flex items-center gap-2">
                                            <span>üìù</span> Informations
                                        </h4>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-xs font-bold text-gray-600 mb-1">Nom</label>
                                                <input type="text" value={eleveEnEdition.nom} onChange={(e) => setEleveEnEdition({ ...eleveEnEdition, nom: e.target.value })} className="w-full border border-gray-300 p-2.5 rounded-lg uppercase text-sm focus:ring-2 focus:ring-teal-500 outline-none" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-600 mb-1">Pr√©nom</label>
                                                <input type="text" value={eleveEnEdition.prenom} onChange={(e) => setEleveEnEdition({ ...eleveEnEdition, prenom: e.target.value })} className="w-full border border-gray-300 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-bold text-gray-600 mb-1">Email</label>
                                                <input type="email" value={eleveEnEdition.email || ''} onChange={(e) => setEleveEnEdition({ ...eleveEnEdition, email: e.target.value })} className="w-full border border-gray-300 p-2.5 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 outline-none" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-600 mb-1">Solde Cr√©dits</label>
                                                <div className="relative">
                                                    <input type="number" value={editCredits} onChange={(e) => setEditCredits(e.target.value)} className="w-full border border-purple-200 p-2.5 rounded-lg font-bold bg-purple-50 text-purple-700 focus:ring-2 focus:ring-purple-500 outline-none pl-9" />
                                                    <span className="absolute left-3 top-2.5 text-purple-400">üé´</span>
                                                </div>
                                                <p className="text-[9px] text-gray-400 mt-1 italic leading-tight">La modification du solde cr√©era une ligne d'historique.</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* BLOC 2: GROUPES */}
                                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                                        <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-b pb-2 flex items-center gap-2">
                                            <span>üìÖ</span> Inscriptions R√©currentes
                                        </h4>
                                        <div className="flex justify-between items-center mb-3">
                                            <p className="text-[11px] text-gray-400 italic">Cochez les cr√©neaux habituels de l'√©l√®ve.</p>
                                            <span className="text-[10px] bg-teal-50 text-teal-700 px-2 py-0.5 rounded border border-teal-100 font-bold">Actifs uniquement</span>
                                        </div>
                                        
                                        <div className="grid md:grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-1">
                                            {groupes.filter(g => isGroupActive(g)).map(groupe => {
                                                const estInscrit = eleveEnEdition.enrolledGroupIds?.includes(groupe.id);
                                                return (
                                                    <label key={groupe.id} className={`flex items-center p-2.5 rounded-lg border cursor-pointer select-none transition-all ${estInscrit ? 'bg-teal-50 border-teal-500 shadow-sm ring-1 ring-teal-500' : 'border-gray-100 hover:bg-gray-50'}`}>
                                                        <input type="checkbox" className="w-4 h-4 text-teal-600 rounded border-gray-300 focus:ring-teal-500" checked={estInscrit || false} onChange={() => toggleGroupePourEleve(groupe.id)} />
                                                        <div className="ml-3 leading-tight">
                                                            <span className={`block text-sm font-bold ${estInscrit ? 'text-teal-900' : 'text-gray-600'}`}>{groupe.nom}</span>
                                                            <span className="text-[10px] text-gray-400 uppercase font-semibold tracking-wide">{JOURS[groupe.jour]} ‚Ä¢ {groupe.heureDebut}</span>
                                                        </div>
                                                    </label>
                                                );
                                            })}
                                            {groupes.filter(g => isGroupActive(g)).length === 0 && (
                                                <p className="col-span-2 text-center text-gray-400 text-sm italic py-4">Aucun groupe actif disponible.</p>
                                            )}
                                        </div>
                                    </div>
                                </>
                            )}

                            {/* --- ONGLET HISTORY --- */}
                            {activeTab === 'history' && (
                                <div className="space-y-3">
                                    {loadingHistory ? (
                                        <div className="text-center text-gray-400 py-10">Chargement de l'historique...</div>
                                    ) : history.length === 0 ? (
                                        <div className="text-center text-gray-400 italic py-10 bg-white rounded-xl border border-dashed border-gray-300">
                                            Aucun historique disponible.
                                        </div>
                                    ) : (
                                        history.map(item => {
                                            const dateItem = item.date ? item.date.toDate() : new Date();
                                            const isPositive = item.delta > 0;
                                            return (
                                                <div key={item.id} className="bg-white p-3 rounded-lg border border-gray-200 flex justify-between items-center text-sm shadow-sm hover:shadow-md transition">
                                                    <div>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className={`text-[10px] font-black px-1.5 py-0.5 rounded ${isPositive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                                {isPositive ? '+' : ''}{item.delta}
                                                            </span>
                                                            <span className="font-bold text-gray-700">{item.motif}</span>
                                                        </div>
                                                        <div className="text-xs text-gray-400 flex gap-2">
                                                            <span>üìÖ {dateItem.toLocaleDateString('fr-FR')}</span>
                                                            <span>üïí {dateItem.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</span>
                                                            {item.seanceDate && <span className="text-gray-500">‚Ä¢ S√©ance : {item.seanceDate}</span>}
                                                        </div>
                                                    </div>
                                                    <button onClick={() => deleteHistoryItem(item.id)} className="text-gray-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition" title="Supprimer cette ligne">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            )
                                        })
                                    )}
                                </div>
                            )}
                        </div>

                        {/* FOOTER MODAL (BOUTONS) */}
                        {activeTab === 'details' && (
                            <div className="p-4 bg-white border-t border-gray-200 flex justify-end gap-3 shrink-0">
                                <button onClick={() => setEleveEnEdition(null)} className="px-5 py-2.5 text-gray-500 font-bold hover:bg-gray-100 rounded-lg transition text-sm">
                                    Annuler
                                </button>
                                <button onClick={sauvegarderEdition} className="px-6 py-2.5 bg-teal-700 text-white font-bold rounded-lg hover:bg-teal-800 shadow-md transform active:scale-95 transition text-sm">
                                    Enregistrer
                                </button>
                            </div>
                        )}
                        {activeTab === 'history' && (
                            <div className="p-4 bg-white border-t border-gray-200 flex justify-end shrink-0">
                                <button onClick={() => setEleveEnEdition(null)} className="px-5 py-2.5 text-gray-600 font-bold hover:bg-gray-100 rounded-lg transition text-sm">
                                    Fermer
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="functions/index.js">
const functions = require("firebase-functions");
const admin = require("firebase-admin");
const fetch = require("node-fetch");

admin.initializeApp();
const db = admin.firestore();

const BREVO_API_KEY = require("./ma-cle");

exports.onPlaceLiberated = functions.region("europe-west1").firestore
    .document("attendance/{seanceId}")
    .onUpdate(async (change, context) => {
        const newData = change.after.data();
        const oldData = change.before.data();

        // 1. V√âRIFICATION : Y a-t-il des gens √† pr√©venir ?
        const waitingList = newData.waitingList || [];
        if (waitingList.length === 0) return null;

        const groupeId = newData.groupeId;
        const dateSeance = newData.date;
        const seanceNom = newData.nomGroupe || "Cours";

        console.log(`üîç [${seanceNom} ${dateSeance}] Analyse suite √† modification...`);

        try {
            // ==================================================================
            // √âTAPE 1 : CAPACIT√â OFFICIELLE (C)
            // ==================================================================
            let capacity = 0;
            let isAjout = false;

            // A. S√©ance Unique (Ajout)
            const exceptionRef = await db.collection("exceptions").doc(groupeId).get();
            if (exceptionRef.exists && exceptionRef.data().type === 'ajout') {
                isAjout = true;
                capacity = parseInt(exceptionRef.data().newSessionData?.places || 0);
            } else {
                // B. Cours R√©current
                const groupRef = await db.collection("groupes").doc(groupeId).get();
                if (!groupRef.exists) {
                    console.error("‚ö†Ô∏è Groupe introuvable en DB.");
                    return null;
                }
                capacity = parseInt(groupRef.data().places || 0);

                // C. Exception de date
                const exQuery = await db.collection("exceptions")
                    .where("groupeId", "==", groupeId)
                    .where("date", "==", dateSeance)
                    .get();

                if (!exQuery.empty) {
                    const exData = exQuery.docs[0].data();
                    if (exData.type === 'annulation') return null;
                    if (exData.newSessionData?.places !== undefined) {
                        capacity = parseInt(exData.newSessionData.places);
                        console.log(`‚ÑπÔ∏è Capacit√© modifi√©e exceptionnellement : ${capacity}`);
                    }
                }
            }

            // ==================================================================
            // √âTAPE 2 : COMPTAGE PR√âCIS DES HUMAINS
            // ==================================================================

            // R√©cup√©ration des titulaires (Inscrits √† l'ann√©e)
            let titulairesIds = [];
            if (!isAjout) {
                const titulairesSnap = await db.collection("eleves")
                    .where("enrolledGroupIds", "array-contains", groupeId)
                    .get();
                titulairesIds = titulairesSnap.docs.map(d => d.id);
            }

            // Fonction de comptage avec LOGS D√âTAILL√âS
            const countOccupants = (attendanceData, label) => {
                const statusMap = attendanceData.status || {};
                let count = 0;
                let details = [];

                if (isAjout) {
                    count = Object.values(statusMap).filter(s => s === 'present').length;
                } else {
                    // 1. Titulaires
                    titulairesIds.forEach(tid => {
                        const s = statusMap[tid];
                        // Un titulaire compte SAUF s'il est marqu√© absent
                        const isAbsent = (s === 'absent' || s === 'absent_announced');
                        if (!isAbsent) {
                            count++;
                        } else {
                            // On note qui est absent pour le debug
                            details.push(`Titulaire Absent: ${tid}`);
                        }
                    });

                    // 2. Invit√©s
                    Object.keys(statusMap).forEach(uid => {
                        if (statusMap[uid] === 'present' && !titulairesIds.includes(uid)) {
                            count++;
                            details.push(`Invit√©: ${uid}`);
                        }
                    });
                }

                // Afficher les d√©tails s'il y a des absents/invit√©s (pour comprendre le calcul)
                if (details.length > 0) console.log(`üìã D√©tails ${label}:`, details);
                return count;
            };

            const countBefore = countOccupants(oldData, "AVANT");
            const countAfter = countOccupants(newData, "APR√àS");

            console.log(`üìä Bilan Math√©matique : Avant=${countBefore} -> Apr√®s=${countAfter} (Capacit√©=${capacity})`);

            // ==================================================================
            // √âTAPE 3 : D√âCISION STRICTE
            // ==================================================================

            // Si c'√©tait d√©j√† libre avant, on ne fait rien (√©vite les doublons)
            if (countBefore < capacity) {
                console.log("üõë Le cours √©tait D√âJ√Ä libre avant la modif. Pas de mail.");
                return null;
            }

            // Si c'est TOUJOURS complet (ou surnombre), on ne fait rien
            if (countAfter >= capacity) {
                console.log("üõë Le cours est TOUJOURS complet. Pas de mail.");
                return null;
            }

            // Si on arrive ici, c'est que : AVANT >= CAPACIT√â  et  APR√àS < CAPACIT√â
            console.log("‚úÖ D√âCLENCHEMENT : Une place vient vraiment de se lib√©rer.");

            // ==================================================================
            // √âTAPE 4 : ENVOI MAIL
            // ==================================================================
            const emails = [];
            for (const uid of waitingList) {
                const docEleve = await db.collection("eleves").doc(uid).get();
                if (docEleve.exists && docEleve.data().email) {
                    emails.push({ email: docEleve.data().email, name: docEleve.data().prenom });
                }
            }

            if (emails.length === 0) return null;

            const placesRestantes = capacity - countAfter;
            // Formatage de la date : YYYY-MM-DD -> JJ/MM/AAAA
            const [annee, mois, jour] = dateSeance.split("-");
            const dateFr = `${jour}/${mois}/${annee}`;

            const emailData = {
                sender: { name: "Yoga Sandrine", email: "putod.sandrine@gmail.com" },
                to: emails,
                subject: "Une place s'est lib√©r√©e ! üßò‚Äç‚ôÄÔ∏è",
                htmlContent: `
                    <div style="font-family: Arial, sans-serif; color: #333; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #0d9488;">Une place vous attend !</h2>
                        
                        <p style="font-weight: bold; color: #c2410c;">Bonjour,</p>
                        <p style="font-weight: bold; color: #c2410c;">Une place vient de se lib√©rer pour un cours o√π tu es not√©(e) en attente :</p>
                        <div style="background-color: #f0fdfa; padding: 15px; border-left: 4px solid #0d9488; margin: 20px 0;">
                            <strong>${seanceNom}</strong><br>
                            Date : ${dateFr}<br>
                            <small>Places disponibles : ${placesRestantes}</small>
                        </div>
                        
                         <p style="font-weight: bold; color: #c2410c;">Si tu souhaites venir, pense √† aller t'inscrire sur le planning !</p>
                        <p style="font-weight: bold; color: #c2410c;">Premier arriv√©, premier servi.</p>
                        <div style="text-align: center; margin-top: 30px;">
                            <a href="https://gestion-yoga.pages.dev" style="background-color: #0d9488; color: white; padding: 12px 25px; text-decoration: none; border-radius: 8px; font-weight: bold;">
                                R√©server maintenant
                            </a>
                        </div>
                    </div>
                `
            };

            await fetch("https://api.brevo.com/v3/smtp/email", {
                method: "POST",
                headers: {
                    "accept": "application/json",
                    "api-key": BREVO_API_KEY,
                    "content-type": "application/json"
                },
                body: JSON.stringify(emailData)
            });
            console.log(`üì® Mails envoy√©s √† ${emails.length} personnes.`);

        } catch (error) {
            console.error("‚ùå Erreur critique :", error);
        }

        return null;
    });
</file>

<file path="src/Planning.jsx">
import { useState, useEffect, useRef } from 'react';
import { db } from './firebase';
import { collection, getDocs, query, where } from 'firebase/firestore';
import GestionSeance from './GestionSeance';
import AjoutSeance from './AjoutSeance';
import GestionGroupes from './GestionGroupes';

const JOURS = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
const MOIS = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Juin", "Juil", "Ao√ªt", "Sep", "Oct", "Nov", "D√©c"];

// --- CONFIGURATION CALENDRIER ---
const HEURE_DEBUT = 8;
const HEURE_FIN = 21;
const PIXELS_PAR_HEURE = 80;

// --- HELPERS ---
const getLundi = (d) => {
    const date = new Date(d);
    const day = date.getDay();
    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
    date.setDate(diff);
    date.setHours(0, 0, 0, 0);
    return date;
};

const ajouterJours = (date, jours) => {
    const result = new Date(date);
    result.setDate(result.getDate() + jours);
    result.setHours(0, 0, 0, 0);
    return result;
};

const formaterDateSimple = (date) => `${date.getDate()} ${MOIS[date.getMonth()]}`;

export default function Planning() {
    // --- √âTATS ---
    const [coursAffiches, setCoursAffiches] = useState([]);
    const [donneesBrutes, setDonneesBrutes] = useState({ groupes: [], eleves: [], exceptions: [], attendances: [] });
    const [loading, setLoading] = useState(true);
    const [lundiActuel, setLundiActuel] = useState(getLundi(new Date()));
    const datePickerRef = useRef(null);

    // --- MODES D'AFFICHAGE (Nouveau) ---
    const [selectedStudentId, setSelectedStudentId] = useState(""); // Si vide = Vue Professeur

    // --- MODALES & S√âLECTIONS ---
    const [groupeAEditerId, setGroupeAEditerId] = useState(null);
    const [seanceSelectionnee, setSeanceSelectionnee] = useState(null);
    const [showAjoutModal, setShowAjoutModal] = useState(false);
    const [showGestionGroupes, setShowGestionGroupes] = useState(false);
    const [exceptionAEditer, setExceptionAEditer] = useState(null);
    const [choixCreation, setChoixCreation] = useState(null); // { date, heure }

    // --- CHARGEMENT INITIAL ---
    useEffect(() => {
        fetchDonnees();
    }, [lundiActuel]);

    const fetchDonnees = async () => {
        try {
            setLoading(true);
            const debutSemaineStr = lundiActuel.toLocaleDateString('fr-CA');
            const finSemaine = ajouterJours(lundiActuel, 6);
            const finSemaineStr = finSemaine.toLocaleDateString('fr-CA');

            // Chargement parall√®le pour optimiser
            const [groupesSnap, elevesSnap, exceptionsSnap, attendanceSnap] = await Promise.all([
                getDocs(query(collection(db, "groupes"), where("actif", "==", true))),
                getDocs(collection(db, "eleves")),
                getDocs(collection(db, "exceptions")),
                getDocs(query(collection(db, "attendance"), where("date", ">=", debutSemaineStr), where("date", "<=", finSemaineStr)))
            ]);

            const elevesData = elevesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            elevesData.sort((a, b) => a.nom.localeCompare(b.nom)); // Tri pour le menu d√©roulant

            setDonneesBrutes({
                groupes: groupesSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                eleves: elevesData,
                exceptions: exceptionsSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                attendances: attendanceSnap.docs.map(d => ({ id: d.id, ...d.data() }))
            });
        } catch (error) {
            console.error("Erreur chargement:", error);
        } finally {
            setLoading(false);
        }
    };

    // --- CALCUL DU PLANNING ---
    // D√©clench√© quand les donn√©es changent OU quand on change d'√©l√®ve s√©lectionn√©
    useEffect(() => {
        if (!loading) calculerPlanningDeLaSemaine();
    }, [lundiActuel, donneesBrutes, loading, selectedStudentId]);

    const calculerPlanningDeLaSemaine = () => {
        const { groupes, eleves, exceptions, attendances } = donneesBrutes;
        let listeFinale = [];
        const now = new Date();

        // Si un √©l√®ve est s√©lectionn√©, on le r√©cup√®re
        const selectedStudent = selectedStudentId ? eleves.find(e => e.id === selectedStudentId) : null;

        // Fonction helper locale pour calculer l'occupation ET le statut de l'√©l√®ve cible
        const getStatsSeance = (groupeId, dateStr, isException, inscritsBase) => {
            const seanceId = isException ? groupeId : `${dateStr}_${groupeId}`;
            const attendanceDoc = attendances.find(a => a.id === seanceId);

            let nbAbsents = 0;
            let nbInvites = 0;
            let waitingCount = 0;

            // Statut sp√©cifique de l'√©l√®ve regard√© (si actif)
            let studentStatus = { enrolled: false, absent: false, guest: false, waiting: false, waitingPos: null };

            // 1. Est-il inscrit de base ?
            if (selectedStudent && !isException) {
                studentStatus.enrolled = selectedStudent.enrolledGroupIds && selectedStudent.enrolledGroupIds.includes(groupeId);
            }

            if (attendanceDoc) {
                const status = attendanceDoc.status || {};
                waitingCount = attendanceDoc.waitingList ? attendanceDoc.waitingList.length : 0;

                // V√©rif file d'attente
                if (selectedStudent && attendanceDoc.waitingList && attendanceDoc.waitingList.includes(selectedStudent.id)) {
                    studentStatus.waiting = true;
                    studentStatus.waitingPos = attendanceDoc.waitingList.indexOf(selectedStudent.id) + 1;
                }

                Object.entries(status).forEach(([uid, st]) => {
                    const eleve = eleves.find(e => e.id === uid);
                    if (!eleve) return; // S√©curit√©

                    // Est-ce un titulaire ?
                    const estInscrit = !isException && eleve.enrolledGroupIds && eleve.enrolledGroupIds.includes(groupeId);

                    if (estInscrit && (st === 'absent' || st === 'absent_announced')) {
                        nbAbsents++;
                        if (selectedStudent && uid === selectedStudent.id) studentStatus.absent = true;
                    }
                    if (!estInscrit && st === 'present') {
                        nbInvites++;
                        if (selectedStudent && uid === selectedStudent.id) studentStatus.guest = true;
                    }
                });
            }

            return {
                reel: inscritsBase - nbAbsents + nbInvites,
                waitingCount,
                studentStatus // On retourne l'objet statut
            };
        };

        // 1. Traitement des Groupes R√©currents
        groupes.forEach(groupe => {
            const dateDuCours = ajouterJours(lundiActuel, groupe.jour - 1);

            // V√©rification Dates de saison
            if (groupe.dateDebut && groupe.dateFin) {
                const debut = groupe.dateDebut.toDate ? groupe.dateDebut.toDate() : new Date(groupe.dateDebut);
                const fin = groupe.dateFin.toDate ? groupe.dateFin.toDate() : new Date(groupe.dateFin);
                debut.setHours(0, 0, 0, 0); fin.setHours(23, 59, 59, 999);
                if (dateDuCours < debut || dateDuCours > fin) return;
            }

            const dateStr = dateDuCours.toLocaleDateString('fr-CA');

            // MODIFICATION ICI : R√©cup√©ration de l'objet exception complet
            const exceptionAnnulation = exceptions.find(ex => ex.groupeId === groupe.id && ex.date === dateStr && ex.type === "annulation");
            const estAnnule = !!exceptionAnnulation;
            const motifAnnulation = exceptionAnnulation?.motif || "";

            const inscritsCount = eleves.filter(e => e.enrolledGroupIds && e.enrolledGroupIds.includes(groupe.id)).length;
            const stats = getStatsSeance(groupe.id, dateStr, false, inscritsCount);

            // Calcul si Pass√©
            const [h, min] = groupe.heureDebut.split(':').map(Number);
            const sessionEnd = new Date(dateDuCours);
            sessionEnd.setHours(h, min + (groupe.duree || 60), 0, 0);
            const isPast = now > sessionEnd;

            listeFinale.push({
                ...groupe,
                dateReelle: dateDuCours,
                type: 'standard',
                estAnnule,
                motifAnnulation, // On passe le motif
                inscritsCount,
                presentCount: stats.reel,
                waitingCount: stats.waitingCount,
                studentStatus: stats.studentStatus,
                isPast
            });
        });

        // 2. Traitement des S√©ances Exceptionnelles (Ajouts)
        const dimancheFinStr = ajouterJours(lundiActuel, 6).toLocaleDateString('fr-CA');
        const lundiDebutStr = lundiActuel.toLocaleDateString('fr-CA');
        const ajoutsSemaine = exceptions.filter(ex => ex.type === "ajout" && ex.date >= lundiDebutStr && ex.date <= dimancheFinStr);

        ajoutsSemaine.forEach(ajout => {
            const [y, m, d] = ajout.date.split('-').map(Number);
            const dateReelle = new Date(y, m - 1, d);
            const stats = getStatsSeance(ajout.id, ajout.date, true, 0);

            // V√©rif si annul√© (m√™me une s√©ance exceptionnelle peut √™tre annul√©e via GestionSeance)
            const exceptionAnnulation = exceptions.find(ex => ex.groupeId === ajout.id && ex.date === ajout.date && ex.type === "annulation");
            const estAnnule = !!exceptionAnnulation;
            const motifAnnulation = exceptionAnnulation?.motif || "";

            // Calcul si Pass√©
            const [h, min] = ajout.newSessionData.heureDebut.split(':').map(Number);
            const sessionEnd = new Date(dateReelle);
            sessionEnd.setHours(h, min + (ajout.newSessionData.duree || 60), 0, 0);
            const isPast = now > sessionEnd;

            listeFinale.push({
                id: ajout.id,
                ...ajout.newSessionData,
                dateReelle,
                type: 'ajout',
                estAnnule,
                motifAnnulation, // On passe le motif
                inscritsCount: 0,
                presentCount: stats.reel,
                waitingCount: stats.waitingCount,
                originalExceptionId: ajout.id,
                studentStatus: stats.studentStatus,
                isPast
            });
        });

        // Tri chronologique
        listeFinale.sort((a, b) => a.dateReelle - b.dateReelle || a.heureDebut.localeCompare(b.heureDebut));
        setCoursAffiches(listeFinale);
    };

    // --- ACTIONS NAVIGATION ---
    const changerSemaine = (offset) => setLundiActuel(prev => ajouterJours(prev, offset * 7));

    // --- ACTIONS CLIC GRILLE ---
    const handleCellClick = (dateJour, heureInt) => {
        const heureStr = `${heureInt.toString().padStart(2, '0')}:00`;
        setChoixCreation({ date: dateJour, heure: heureStr });
    };

    const handleChoix = (type) => {
        if (type === 'hebdo') {
            setShowGestionGroupes(true);
        } else if (type === 'unique') {
            setExceptionAEditer({
                date: choixCreation.date.toLocaleDateString('fr-CA'),
                heureDebut: choixCreation.heure
            });
            setShowAjoutModal(true);
        }
        setChoixCreation(null);
    };

    const getCardStyle = (heureDebut, duree) => {
        const [h, m] = heureDebut.split(':').map(Number);
        const minutesDepuisDebut = (h - HEURE_DEBUT) * 60 + m;
        const top = (minutesDepuisDebut / 60) * PIXELS_PAR_HEURE;
        const height = (duree / 60) * PIXELS_PAR_HEURE;
        return { top: `${top}px`, height: `${height}px` };
    };

    const calculerHeureFin = (heureDebut, dureeMinutes) => {
        const [h, m] = heureDebut.split(':').map(Number);
        const date = new Date();
        date.setHours(h, m, 0, 0);
        date.setMinutes(date.getMinutes() + dureeMinutes);
        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }).replace(':', 'h');
    };

    if (loading) return <div className="flex justify-center items-center h-64 text-teal-600 font-bold">Chargement...</div>;
    const dimancheFinSemaine = ajouterJours(lundiActuel, 6);

    return (
        <div className="max-w-7xl mx-auto p-2 md:p-6">

            {/* --- MODALE DE CHOIX CR√âATION (Clic grille) --- */}
            {choixCreation && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setChoixCreation(null)}>
                    <div className="bg-white p-6 rounded-2xl shadow-2xl w-80 text-center space-y-6" onClick={e => e.stopPropagation()}>
                        <div>
                            <h3 className="font-bold text-xl text-gray-800 font-playfair mb-1">Ajouter un cr√©neau</h3>
                            <p className="text-sm text-gray-500 font-medium capitalize">
                                {choixCreation.date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric' })} ‚Ä¢ {choixCreation.heure}
                            </p>
                        </div>
                        <div className="flex flex-col gap-3">
                            <button onClick={() => handleChoix('hebdo')} className="p-4 bg-teal-50 text-teal-800 border border-teal-200 rounded-xl font-bold hover:bg-teal-100 transition flex items-center gap-3 text-left">
                                <span className="text-2xl">üìÖ</span>
                                <div className="leading-tight">
                                    <span className="block text-sm">Cours Hebdomadaire</span>
                                    <span className="text-[10px] text-teal-600/70 uppercase">R√©current toute l'ann√©e</span>
                                </div>
                            </button>
                            <button onClick={() => handleChoix('unique')} className="p-4 bg-purple-50 text-purple-800 border border-purple-200 rounded-xl font-bold hover:bg-purple-100 transition flex items-center gap-3 text-left">
                                <span className="text-2xl">‚ú®</span>
                                <div className="leading-tight">
                                    <span className="block text-sm">S√©ance Exceptionnelle</span>
                                    <span className="text-[10px] text-purple-600/70 uppercase">Une seule fois (Atelier, etc.)</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* --- HEADER --- */}
            <div className="flex flex-col md:flex-row items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-0 z-20">
                <div className="flex flex-col gap-1 w-full md:w-auto">
                    <h2 className="text-xl md:text-2xl font-playfair font-bold text-gray-800 whitespace-nowrap">
                        {formaterDateSimple(lundiActuel)} - {formaterDateSimple(dimancheFinSemaine)} {dimancheFinSemaine.getFullYear()}
                    </h2>

                    {/* S√âLECTEUR DE VUE (PROF ou √âL√àVE) */}
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-bold text-gray-400 uppercase">Vue :</span>
                        <select
                            value={selectedStudentId}
                            onChange={(e) => setSelectedStudentId(e.target.value)}
                            className={`text-xs border rounded px-2 py-1 outline-none font-bold cursor-pointer transition ${selectedStudentId ? 'bg-purple-50 text-purple-800 border-purple-200' : 'bg-white text-gray-600 border-gray-300'}`}
                        >
                            <option value="">üë®‚Äçüè´ Mon Planning Prof</option>
                            <optgroup label="üëÅÔ∏è Voir en tant que...">
                                {donneesBrutes.eleves.map(e => (
                                    <option key={e.id} value={e.id}>{e.nom} {e.prenom}</option>
                                ))}
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div className="flex items-center bg-gray-100 rounded-lg p-1 mt-3 md:mt-0">
                    
                    {/* NAVIGATION SEMAINE AVEC S√âLECTEUR DE DATE CORRIG√â */}
<div className="flex items-center bg-gray-100 rounded-lg p-1 mt-3 md:mt-0 gap-1">
   <button 
        type="button" 
        // REMPLACE "changerSemaine(-1)" PAR CECI :
        onClick={() => setLundiActuel(prev => ajouterJours(prev, -7))} 
        className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600 font-bold transition"
    >
        ‚Üê
    </button>


{/* --- S√âLECTEUR DE DATE CORRIG√â --- */}
<div className="relative group">
    <input 
        type="date" 
        id="date-picker-planning" // ID unique pour √©viter les conflits
        className="absolute opacity-0 w-0 h-0" // On retire top-0 left-0 qui causait le bug d'ancrage
        onChange={(e) => {
            if(e.target.value) setLundiActuel(getLundi(new Date(e.target.value)));
        }}
    />
    
    <button 
        type="button" 
        onClick={() => {
            // M√©thode robuste utilis√©e dans StudentPortal
            try {
                document.getElementById('date-picker-planning').showPicker();
            } catch (e) {
                // Fallback au cas o√π
                console.warn(e);
                document.getElementById('date-picker-planning').focus(); 
            }
        }}
        className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600 font-bold transition cursor-pointer"
        title="Choisir une date"
    >
        üìÖ
    </button>
</div>

    <button 
        type="button" 
        onClick={() => setLundiActuel(getLundi(new Date()))} 
        className="px-3 py-1 hover:bg-white rounded-md text-teal-700 font-bold text-sm uppercase transition"
    >
        Auj.
    </button>
<button 
        type="button" 
        // REMPLACE "changerSemaine(1)" PAR CECI :
        onClick={() => setLundiActuel(prev => ajouterJours(prev, 7))} 
        className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600 font-bold transition"
    >
        ‚Üí
    </button>
</div>
    
 
 
                </div>
            </div>

            {/* VUE MOBILE */}
            <div className="block md:hidden space-y-4">
                {coursAffiches.map((groupe) => {
                    const taux = groupe.presentCount / groupe.places;
                    const estComplet = taux >= 1;

                    // Style de base Mobile
                    let borderClass = 'border-teal-500';
                    let opacityClass = '';

                    if (groupe.estAnnule) {
                        borderClass = 'border-red-400';
                        opacityClass = 'opacity-75';
                    } else if (groupe.isPast) {
                        borderClass = 'border-gray-400';
                        opacityClass = 'opacity-60 grayscale'; // GRIS√â SI PASS√â
                    } else if (estComplet) {
                        borderClass = 'border-red-500';
                    }

                    // Badge sp√©cial si vue √©l√®ve
                    let mobileBadge = null;
                    if (selectedStudentId && !groupe.estAnnule) {
                        const s = groupe.studentStatus;
                        if (s.enrolled) {
                            if (s.absent) mobileBadge = <span className="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200 font-bold ml-2">ABSENT</span>;
                            else mobileBadge = <span className="text-[10px] bg-teal-100 text-teal-700 px-2 py-0.5 rounded border border-teal-200 font-bold ml-2">INSCRIT</span>;
                        } else if (s.guest) {
                            mobileBadge = <span className="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200 font-bold ml-2">R√âSERV√â</span>;
                        } else if (s.waiting) {
                            mobileBadge = <span className="text-[10px] bg-orange-50 text-orange-600 px-2 py-0.5 rounded border border-orange-100 font-bold ml-2">ATTENTE {s.waitingPos}</span>;
                        }
                    }

                    return (
                        <div key={groupe.id + groupe.dateReelle.toString()} className={`bg-white rounded-lg shadow border-l-4 p-4 flex justify-between items-center ${borderClass} ${opacityClass}`}>
                            <div>
                                <div className="text-xs uppercase text-gray-400 font-bold mb-1 flex items-center">
                                    {JOURS[groupe.dateReelle.getDay()]} {groupe.dateReelle.getDate()} ‚Ä¢ {groupe.heureDebut}
                                    {mobileBadge}
                                </div>
                                <h3 className={`font-bold text-lg ${groupe.estAnnule ? 'line-through text-gray-400' : 'text-gray-800'}`}>
                                    {groupe.nom}
                                </h3>
                                {/* Affichage Th√®me Mobile */}
                                {groupe.theme && <div className="text-xs text-purple-600 italic mb-1">"{groupe.theme}"</div>}

                                {/* MODIFICATION : Affichage Motif Annulation Mobile */}
                                {groupe.estAnnule && groupe.motifAnnulation && (
                                    <div className="text-xs text-red-500 font-bold italic mt-1">
                                        "{groupe.motifAnnulation}"
                                    </div>
                                )}

                                <div className="text-sm mt-1">
                                    {groupe.estAnnule ? (
                                        <span className="text-red-500 font-bold">ANNUL√â</span>
                                    ) : (
                                        <span className={`${estComplet && !groupe.isPast ? 'text-red-600 font-bold' : 'text-gray-600'}`}>
                                            üë• {groupe.presentCount} / {groupe.places}
                                        </span>
                                    )}
                                </div>
                            </div>
                            <button onClick={() => setSeanceSelectionnee({ groupe: groupe, date: groupe.dateReelle })} className="bg-gray-50 text-gray-600 px-3 py-2 rounded border font-bold text-sm">
                                G√©rer
                            </button>
                        </div>
                    );
                })}
                {coursAffiches.length === 0 && <div className="text-center py-10 text-gray-400">Aucun cours cette semaine.</div>}
            </div>

            {/* VUE DESKTOP */}
            <div className="hidden md:flex bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden relative">

                {/* COLONNE HEURES */}
                <div className="w-16 bg-gray-50 border-r border-gray-200 flex-shrink-0 relative" style={{ height: (HEURE_FIN - HEURE_DEBUT) * PIXELS_PAR_HEURE }}>
                    {Array.from({ length: HEURE_FIN - HEURE_DEBUT }).map((_, i) => (
                        <div key={i} className="absolute w-full text-center text-xs text-gray-400 font-bold border-b border-gray-100" style={{ top: i * PIXELS_PAR_HEURE, height: PIXELS_PAR_HEURE }}>
                            {i + HEURE_DEBUT}:00
                        </div>
                    ))}
                </div>

                {/* GRILLE JOURS */}
                <div className="flex-1 grid grid-cols-7 divide-x divide-gray-200">
                    {[1, 2, 3, 4, 5, 6, 0].map((jourIndex) => {
                        const dateJour = ajouterJours(lundiActuel, jourIndex === 0 ? 6 : jourIndex - 1);
                        const isToday = new Date().toDateString() === dateJour.toDateString();
                        const coursDuJour = coursAffiches.filter(c => c.dateReelle.getDay() === jourIndex);

                        return (
                            <div key={jourIndex} className={`relative ${isToday ? 'bg-teal-50/20' : ''}`} style={{ height: (HEURE_FIN - HEURE_DEBUT) * PIXELS_PAR_HEURE }}>

                                {/* En-t√™te Jour */}
                                <div className={`text-center py-2 border-b border-gray-200 sticky top-0 z-10 ${isToday ? 'bg-teal-100 text-teal-900 font-bold' : 'bg-gray-50 text-gray-600'}`}>
                                    <div className="text-xs uppercase tracking-wide">{JOURS[jourIndex].substring(0, 3)}</div>
                                    <div className="text-lg">{dateJour.getDate()}</div>
                                </div>

                                {/* Lignes rep√®res CLIQUABLES */}
                                {Array.from({ length: HEURE_FIN - HEURE_DEBUT }).map((_, i) => (
                                    <div
                                        key={i}
                                        onClick={() => handleCellClick(dateJour, i + HEURE_DEBUT)}
                                        className="absolute w-full border-b border-gray-100 cursor-cell hover:bg-gray-50 transition-colors z-0"
                                        style={{ top: i * PIXELS_PAR_HEURE, height: PIXELS_PAR_HEURE }}
                                        title="Cliquez pour ajouter un cours"
                                    ></div>
                                ))}

                                {/* CARTES COURS */}
                                {coursDuJour.map(groupe => {
                                    const stylePos = getCardStyle(groupe.heureDebut, groupe.duree);
                                    const isFull = groupe.presentCount >= groupe.places;

                                    // --- LOGIQUE COULEURS & STYLES ---
                                    let containerClass = "hover:shadow-md cursor-pointer border-l-4 transition-all opacity-95 hover:opacity-100 flex flex-col justify-between";
                                    let titleColor = "text-gray-700";

                                    if (groupe.estAnnule) {
                                        containerClass += " bg-gray-100 border-gray-400 opacity-60 text-gray-500";
                                    } else if (groupe.isPast) {
                                        // GRIS√â si pass√© (mais toujours cliquable pour le prof)
                                        containerClass += " bg-gray-100 border-gray-300 opacity-70 grayscale";
                                        titleColor = "text-gray-500";
                                    } else {
                                        // MODE √âL√àVE S√âLECTIONN√â : On imite la vue √©l√®ve
                                        if (selectedStudentId) {
                                            if (groupe.type === 'ajout') containerClass += " bg-purple-50/50 border-purple-200"; // Violet base
                                            else if (isFull) containerClass += " bg-red-50/50 border-red-200"; // Rouge base
                                            else containerClass += " bg-teal-50/30 border-teal-200"; // Vert base
                                        }
                                        // MODE PROF STANDARD : Couleurs par d√©faut
                                        else {
                                            if (groupe.type === 'ajout') { containerClass += " bg-purple-50 border-purple-500 hover:bg-purple-100"; titleColor = "text-purple-900"; }
                                            else if (isFull) { containerClass += " bg-red-50 border-red-500 hover:bg-red-100"; titleColor = "text-red-900"; }
                                            else { containerClass += " bg-teal-50 border-teal-500 hover:bg-teal-100"; titleColor = "text-teal-900"; }
                                        }
                                    }

                                    // OVERLAYS (Uniquement si un √©l√®ve est s√©lectionn√©)
                                    let topBadge = null;
                                    let centerOverlay = null;

                                    if (selectedStudentId && !groupe.estAnnule) {
                                        const s = groupe.studentStatus;
                                        // On r√©plique la logique StudentPortal
                                        if (s.enrolled) {
                                            if (s.absent) centerOverlay = <div className="text-orange-600/80 bg-orange-100/90 px-2 py-1 rounded font-black text-xs -rotate-12 border-2 border-orange-300">ABSENT</div>;
                                            else centerOverlay = <div className="bg-white px-2 py-1 rounded border-2 border-teal-600 shadow-sm flex items-center gap-1 z-10"><span className="text-teal-700 font-black text-xs">INSCRIT</span></div>;
                                        } else if (s.guest) {
                                            centerOverlay = <div className="bg-white px-2 py-1 rounded border-2 border-purple-600 shadow-sm flex items-center gap-1 z-10"><span className="text-purple-700 font-black text-xs">R√âSERV√â</span></div>;
                                        } else if (s.waiting) {
                                            centerOverlay = <div className="bg-orange-100 text-orange-800 font-bold px-2 py-1 rounded text-xs z-10 border border-orange-200">File d'attente :  {s.waitingPos}e</div>;
                                        }
                                    }

                                    // Badge "Sp√©cial" (pour mode prof ou √©l√®ve)
                                    if (groupe.type === 'ajout' && !groupe.isPast && !groupe.estAnnule && !centerOverlay) {
                                        topBadge = <span className="text-[9px] font-bold text-purple-700 bg-white/80 px-1 rounded">SP√âCIAL</span>;
                                    }

                                    return (
                                        <div
                                            key={groupe.id}
                                            onClick={(e) => { e.stopPropagation(); setSeanceSelectionnee({ groupe: groupe, date: groupe.dateReelle }); }}
                                            className={`absolute left-1 right-1 rounded-md p-2 border-l-4 cursor-pointer transition-all shadow-sm hover:shadow-md overflow-hidden flex flex-col justify-between z-10 ${containerClass}`}
                                            style={stylePos}
                                            title={`${groupe.nom} (${groupe.heureDebut})`}
                                        >
                                            <div>
                                                <div className="flex justify-between items-start">
                                                    {/* Badge Sp√©cial en haut √† droite si n√©cessaire */}
                                                    <div className="w-full">
                                                        <div className={`font-bold text-xs md:text-sm leading-tight truncate ${titleColor}`}>
                                                            {groupe.estAnnule && "üö´ "}{groupe.nom}
                                                        </div>
                                                        <div className="text-[10px] opacity-80 font-mono mt-0.5">
                                                            {groupe.heureDebut.replace(':', 'h')} - {calculerHeureFin(groupe.heureDebut, groupe.duree)}
                                                        </div>
                                                        {/* MODIFICATION : Affichage Motif Annulation Desktop */}
                                                        {groupe.estAnnule && groupe.motifAnnulation && (
                                                            <div className="text-[10px] italic font-semibold text-gray-500 mt-1 leading-tight border-t border-gray-300 pt-0.5">
                                                                "{groupe.motifAnnulation}"
                                                            </div>
                                                        )}
                                                    </div>
                                                    {topBadge}
                                                </div>
                                                {/* Petit badge th√®me */}
                                                {groupe.theme && !groupe.estAnnule && (
                                                    <div className="text-[9px] italic mt-1 truncate opacity-90 border-t border-black/5 pt-0.5">
                                                        "{groupe.theme}"
                                                    </div>
                                                )}
                                            </div>

                                            {/* OVERLAY STATUT √âL√àVE */}
                                            {centerOverlay && (
                                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                    {centerOverlay}
                                                </div>
                                            )}

                                            {!groupe.estAnnule && (
                                                <div className="flex justify-between items-end mt-1 pt-1 border-t border-black/5 relative z-0">
                                                    <div className="flex items-center gap-1">
                                                        <span className={`text-xs font-extrabold ${isFull && !groupe.isPast ? 'text-red-600' : 'opacity-100'}`}>
                                                            üë• {groupe.presentCount}/{groupe.places}
                                                        </span>
                                                    </div>
                                                    {groupe.waitingCount > 0 && (
                                                        <span className="text-[9px] font-bold bg-orange-200 text-orange-800 px-1.5 py-0.5 rounded-full">
                                                            +{groupe.waitingCount}
                                                        </span>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* MODALES */}
            {seanceSelectionnee && (
                <GestionSeance
                    groupe={seanceSelectionnee.groupe}
                    date={seanceSelectionnee.date}
                    onClose={() => { setSeanceSelectionnee(null); fetchDonnees(); }}
                    onEdit={(groupeAEditer) => {
                        setSeanceSelectionnee(null); // On ferme la vue d√©tail

                        if (groupeAEditer.type === 'ajout') {
                            // CAS 1 : C'est une exception (AjoutSeance)
                            setExceptionAEditer({
                                id: groupeAEditer.id,
                                type: 'ajout',
                                originalExceptionId: groupeAEditer.originalExceptionId,
                                date: groupeAEditer.dateReelle.toLocaleDateString('fr-CA'),
                                ...groupeAEditer
                            });
                            setShowAjoutModal(true);
                        } else {
                            // CAS 2 : C'est un cours r√©current (GestionGroupes)
                            setGroupeAEditerId(groupeAEditer.id); // On stocke l'ID
                            setShowGestionGroupes(true); // On ouvre la gestion
                        }
                    }}
                />
            )}
            {showAjoutModal && (
                <AjoutSeance
                    onClose={() => {
                        setShowAjoutModal(false);
                        setExceptionAEditer(null);
                    }}
                    onSuccess={() => fetchDonnees()}
                    initialData={exceptionAEditer}
                />
            )}
            {showGestionGroupes && (
                <GestionGroupes
                    onClose={() => {
                        setShowGestionGroupes(false);
                        setGroupeAEditerId(null); // Important : reset l'ID √† la fermeture
                    }}
                    onUpdate={() => fetchDonnees()}
                    initialEditId={groupeAEditerId} // <-- ON PASSE L'ID ICI
                />
            )}
        </div>
    );
}
</file>

<file path="src/StudentSessionDetail.jsx">
import { useState, useEffect } from 'react';
import { db } from './firebase';
import { doc, getDoc, writeBatch, increment, serverTimestamp, arrayUnion, arrayRemove, Timestamp, deleteField, collection } from 'firebase/firestore';
import ConfirmModal from './components/ConfirmModal';
import toast from 'react-hot-toast';

export default function StudentSessionDetail({ session, student, onClose, onUpdate }) {
    const [attendanceData, setAttendanceData] = useState({ status: {}, replacementLinks: {}, waitingList: [] });
    const [loading, setLoading] = useState(true);
    const [processing, setProcessing] = useState(false);
    const [confirmConfig, setConfirmConfig] = useState(null);

    const { groupe, dateObj, seanceId, dateStr, isExceptionnel, isPast } = session;
    const allEleves = session.donneesGlobales.allEleves;

    useEffect(() => {
        fetchLiveAttendance();
    }, []);

    const fetchLiveAttendance = async () => {
        try {
            const docSnap = await getDoc(doc(db, "attendance", seanceId));
            if (docSnap.exists()) {
                setAttendanceData(docSnap.data());
            } else {
                setAttendanceData({ status: {}, replacementLinks: {}, waitingList: [] });
            }
        } catch (e) {
            console.error(e);
            toast.error("Erreur chargement donn√©es");
        } finally {
            setLoading(false);
        }
    };

    const myId = student.id;
    const myStatus = attendanceData.status?.[myId];
    const isTitulaire = !isExceptionnel && student.enrolledGroupIds && student.enrolledGroupIds.includes(groupe.id);
    const isInWaitingList = attendanceData.waitingList?.includes(myId);

    const inscrits = !isExceptionnel
        ? allEleves.filter(e => e.enrolledGroupIds && e.enrolledGroupIds.includes(groupe.id))
        : [];

    const guestIds = Object.keys(attendanceData.status || {}).filter(uid => {
        const s = attendanceData.status[uid];
        const isTit = inscrits.some(t => t.id === uid);
        return s === 'present' && !isTit;
    });
    const invites = guestIds.map(uid => allEleves.find(e => e.id === uid)).filter(Boolean);
    const replacementLinks = attendanceData.replacementLinks || {};

    const capacity = typeof groupe.places === 'number' ? groupe.places : 10;

    const nbTitulairesPresents = inscrits.filter(t => {
        const s = attendanceData.status?.[t.id];
        return s !== 'absent' && s !== 'absent_announced';
    }).length;

    const nbInvitesTotal = invites.length;
    const totalPresents = nbTitulairesPresents + nbInvitesTotal;
    const isPhysicallyFull = totalPresents >= capacity;

    const addHistoryEntry = (batch, delta, motif) => {
        const historyRef = doc(collection(db, "eleves", myId, "history"));
        batch.set(historyRef, {
            date: serverTimestamp(),
            delta: delta,
            motif: motif,
            seanceId: seanceId,
            groupeNom: groupe.nom,
            seanceDate: dateStr
        });
    };

    // --- UI CONFIRMATION ---
    const DetailBox = ({ children, borderColor = "border-gray-200" }) => (
        <div className={`bg-gray-50 p-4 rounded-lg border ${borderColor} text-sm space-y-2`}>{children}</div>
    );
    const Row = ({ label, value, color = "text-gray-800", bold = false }) => (
        <div className={`flex justify-between ${color} ${bold ? 'font-bold' : ''}`}><span>{label}</span><span>{value}</span></div>
    );

    const triggerConfirmation = (actionType, callback) => {
        const solde = student.absARemplacer || 0;
        let config = { onConfirm: callback };

        // Helper pour afficher le solde seulement si ce n'est PAS exceptionnel
        const renderCostInfo = (cout, type = "cost") => {
            if (isExceptionnel) return <p className="text-gray-600 text-sm italic">Cette s√©ance n'impacte pas votre solde de r√©cup√©ration.</p>;

            const nouveauSolde = type === "cost" ? solde - cout : solde + cout;
            const labelCout = type === "cost" ? `-${cout}` : `+${cout}`;
            const colorCout = type === "cost" ? "text-red-600" : "text-green-600";

            return (
                <DetailBox>
                    <Row label="Solde actuel :" value={solde} color="text-gray-500" />
                    <Row label={type === "cost" ? "Co√ªt :" : "Remboursement :"} value={labelCout} color={colorCout} bold />
                    <div className="border-t pt-2 mt-2"><Row label="Nouveau solde :" value={nouveauSolde} bold /></div>
                </DetailBox>
            );
        };

        if (actionType === 'book') {
            config.title = "R√©server ce cours ?";
            config.colorClass = "bg-teal-600";
            config.confirmLabel = isExceptionnel ? "Confirmer la r√©servation" : "Confirmer (-1 s√©ance)";
            config.content = renderCostInfo(1, "cost");

        } else if (actionType === 'cancel_booking') {
            config.title = "Annuler la r√©servation ?";
            config.colorClass = "bg-red-500";
            config.confirmLabel = "Oui, annuler";
            config.content = renderCostInfo(1, "refund");

        } else if (actionType === 'signal_absence') {
            config.title = "Signaler votre absence ?";
            config.colorClass = "bg-orange-500";
            config.confirmLabel = "Lib√©rer ma place";
            config.content = (
                <>
                    <p className="text-gray-600 mb-2 italic text-xs">Merci de pr√©venir !</p>
                    {renderCostInfo(1, "refund")}
                </>
            );

        } else if (actionType === 'signal_absence_late') {
            config.title = "Annulation tardive (< 2h)";
            config.colorClass = "bg-red-500";
            config.confirmLabel = "Confirmer l'absence";
            config.content = (
                <DetailBox borderColor="border-red-200">
                    <p className="text-red-600 mb-2 font-bold text-xs">‚ö†Ô∏è Le cours commence bient√¥t.</p>
                    {!isExceptionnel && <p className="text-gray-600 mb-2 text-xs">Pas de remboursement possible.</p>}
                    <Row label="Solde actuel :" value={solde} color="text-gray-500" />
                    {!isExceptionnel && <Row label="R√©cup√©ration :" value="0" color="text-gray-400" bold />}
                </DetailBox>
            );

        } else if (actionType === 'cancel_absence') {
            config.title = "Reprendre votre place ?";
            config.colorClass = "bg-teal-600";
            config.confirmLabel = "Je reviens";
            config.content = renderCostInfo(1, "cost");

        } else if (actionType === 'waitlist_join') {
            config.title = "Rejoindre la file d'attente ?";
            config.colorClass = "bg-orange-400";
            config.confirmLabel = "M'inscrire";
            config.content = <p className="text-gray-600 text-sm">Vous serez notifi√©(e) par email.</p>;

        } else if (actionType === 'waitlist_leave') {
            config.title = "Quitter la file d'attente ?";
            config.colorClass = "bg-gray-500";
            config.confirmLabel = "Quitter";
            config.content = <p className="text-gray-600 text-sm">Vous ne recevrez plus de notifications.</p>;
        }

        setConfirmConfig(config);
    };

    const handleAction = async (actionFunction, successMessage) => {
        setConfirmConfig(null);
        setProcessing(true);
        const toastId = toast.loading("Traitement...");
        try {
            await actionFunction();
            await fetchLiveAttendance();
            if (onUpdate) onUpdate();
            toast.success(successMessage, { id: toastId });
        } catch (error) {
            console.error(error);
            toast.error("Erreur", { id: toastId });
        } finally {
            setProcessing(false);
        }
    };

    // --- ACTIONS ---

    const toggleMyPresence = () => {
        if (isPast) return;
        const isAbsentNow = myStatus === 'absent' || myStatus === 'absent_announced';
        if (isAbsentNow && isPhysicallyFull) return toast.error("Cours complet.");

        let actionType = 'signal_absence';
        let isLate = false;

        if (isAbsentNow) {
            actionType = 'cancel_absence';
        } else {
            const [h, m] = groupe.heureDebut.split(':').map(Number);
            const courseDate = new Date(dateObj);
            courseDate.setHours(h, m, 0, 0);
            if ((courseDate - new Date()) / 36e5 < 2) {
                actionType = 'signal_absence_late';
                isLate = true;
            }
        }

        triggerConfirmation(actionType, () => handleAction(async () => {
            const batch = writeBatch(db);
            const ref = doc(db, "attendance", seanceId);
            const userRef = doc(db, "eleves", myId);

            if (isAbsentNow) {
                // JE REVIENS
                batch.set(ref, { status: { [myId]: deleteField() } }, { merge: true });
                // Cr√©dit : Seulement si NON exceptionnel
                const delta = isExceptionnel ? 0 : -1;
                if (delta !== 0) batch.update(userRef, { absARemplacer: increment(delta) });
                addHistoryEntry(batch, delta, `Retour : ${groupe.nom} (${dateStr})`);

            } else {
                // JE M'ABSENTE
                batch.set(ref, {
                    date: dateStr, groupeId: groupe.id, nomGroupe: groupe.nom, realDate: Timestamp.fromDate(dateObj),
                    status: { [myId]: 'absent_announced' }, updatedAt: serverTimestamp()
                }, { merge: true });

                if (!isLate) {
                    // √Ä l'avance : Cr√©dit +1 (sauf si exceptionnel)
                    const delta = isExceptionnel ? 0 : 1;
                    if (delta !== 0) batch.update(userRef, { absARemplacer: increment(delta) });
                    addHistoryEntry(batch, delta, `Absence : ${groupe.nom} (${dateStr})`);
                } else {
                    // Tardif : Cr√©dit 0
                    addHistoryEntry(batch, 0, `Absence Tardive : ${groupe.nom} (${dateStr})`);
                }
            }
            await batch.commit();
        }, isLate ? "Not√© (Tardif)." : (isAbsentNow ? "Pr√©sence confirm√©e." : "Absence not√©e.")));
    };

    const bookSpot = () => {
        if (isPast) return;
        triggerConfirmation('book', () => handleAction(async () => {
            const batch = writeBatch(db);
            const ref = doc(db, "attendance", seanceId);
            const userRef = doc(db, "eleves", myId);

            let updateData = {
                date: dateStr, groupeId: groupe.id, nomGroupe: groupe.nom, realDate: Timestamp.fromDate(dateObj),
                status: { [myId]: 'present' }, updatedAt: serverTimestamp()
            };

            // Gestion du lien de remplacement (seulement si standard)
            if (!isExceptionnel) {
                const titulaireAbsentDispo = inscrits.find(t => {
                    const status = attendanceData.status?.[t.id];
                    const estAbsent = status === 'absent' || status === 'absent_announced';
                    const estDejaRemplace = Object.values(replacementLinks).includes(t.id);
                    return estAbsent && !estDejaRemplace;
                });
                if (titulaireAbsentDispo) {
                    updateData.replacementLinks = { ...replacementLinks, [myId]: titulaireAbsentDispo.id };
                }
            }
            if (isInWaitingList) updateData.waitingList = arrayRemove(myId);

            batch.set(ref, updateData, { merge: true });

            // Cr√©dit : -1 seulement si NON exceptionnel
            const delta = isExceptionnel ? 0 : -1;
            if (delta !== 0) batch.update(userRef, { absARemplacer: increment(delta) });

            addHistoryEntry(batch, delta, `R√©servation : ${groupe.nom} (${dateStr})`);

            await batch.commit();
        }, "R√©serv√© !"));
    };

    const cancelBooking = () => {
        if (isPast) return;
        triggerConfirmation('cancel_booking', () => handleAction(async () => {
            const batch = writeBatch(db);
            const ref = doc(db, "attendance", seanceId);
            const userRef = doc(db, "eleves", myId);

            batch.update(ref, {
                [`status.${myId}`]: deleteField(),
                [`replacementLinks.${myId}`]: deleteField()
            });

            // Remboursement : +1 seulement si NON exceptionnel
            const delta = isExceptionnel ? 0 : 1;
            if (delta !== 0) batch.update(userRef, { absARemplacer: increment(delta) });

            addHistoryEntry(batch, delta, `Annulation R√©sa : ${groupe.nom} (${dateStr})`);

            await batch.commit();
        }, "Annul√©."));
    };

    const toggleWaitlist = () => {
        if (isPast) return;
        const action = isInWaitingList ? 'waitlist_leave' : 'waitlist_join';
        triggerConfirmation(action, () => handleAction(async () => {
            const batch = writeBatch(db);
            const ref = doc(db, "attendance", seanceId);
            if (isInWaitingList) batch.update(ref, { waitingList: arrayRemove(myId) });
            else batch.set(ref, {
                date: dateStr, groupeId: groupe.id, nomGroupe: groupe.nom, realDate: Timestamp.fromDate(dateObj),
                waitingList: arrayUnion(myId)
            }, { merge: true });
            await batch.commit();
        }, isInWaitingList ? "Quitt√©." : "Inscrit !"));
    };

    if (loading) return <div className="fixed inset-0 bg-black/80 flex items-center justify-center text-white z-50">Chargement...</div>;

    const linkedGuestIds = Object.keys(replacementLinks).filter(guestId => {
        const titulaireId = replacementLinks[guestId];
        return inscrits.some(t => t.id === titulaireId);
    });
    const freeGuests = invites.filter(i => !linkedGuestIds.includes(i.id));

    const slotsRender = [];
    if (!isExceptionnel) {
        inscrits.forEach(titulaire => slotsRender.push({ type: 'titulaire', student: titulaire }));
    }
    const baseOccupied = isExceptionnel ? 0 : inscrits.length;
    const slotsAvailableForGuests = Math.max(0, capacity - baseOccupied);
    for (let i = 0; i < slotsAvailableForGuests; i++) {
        if (i < freeGuests.length) slotsRender.push({ type: 'guest_in_slot', student: freeGuests[i] });
        else slotsRender.push({ type: 'empty' });
    }
    const overflowGuests = freeGuests.slice(slotsAvailableForGuests);

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
            <ConfirmModal
                isOpen={!!confirmConfig}
                title={confirmConfig?.title}
                confirmLabel={confirmConfig?.confirmLabel}
                colorClass={confirmConfig?.colorClass}
                onConfirm={confirmConfig?.onConfirm}
                onCancel={() => setConfirmConfig(null)}
            >
                {confirmConfig?.content}
            </ConfirmModal>

            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[95vh] relative" onClick={e => e.stopPropagation()}>

                {/* HEADER SP√âCIAL "PASS√â" */}
                {isPast && (
                    <div className="bg-gray-800 text-white text-center py-2 text-xs font-bold uppercase tracking-widest">
                        Ce cours est termin√©
                    </div>
                )}

                <div className={`p-6 text-white flex justify-between items-start ${isExceptionnel ? 'bg-purple-800' : 'bg-teal-900'} ${isPast ? 'opacity-90 saturate-50' : ''}`}>
                    <div>
                        <div className="flex items-center gap-2">
                            <h2 className="text-2xl font-bold font-playfair">{groupe.nom}</h2>
                            {isExceptionnel && <span className="text-[10px] bg-white/20 px-2 py-0.5 rounded uppercase font-bold tracking-wider">S√©ance Unique</span>}
                        </div>
                        <div className="mt-1">
                            <p className="text-white/90 text-sm capitalize">
                                {dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })} ‚Ä¢ {groupe.heureDebut}
                            </p>
                        </div>
                    </div>
                    <button onClick={onClose} className="bg-white/20 hover:bg-white/40 rounded-full w-10 h-10 flex items-center justify-center font-bold">‚úï</button>
                </div>

                <div className="flex-1 overflow-y-auto p-6 bg-gray-100">
                    <div className="flex justify-between items-center mb-6 px-2">
                        <span className="text-xs font-bold uppercase text-gray-500 tracking-wider">Remplissage</span>
                        <span className={`text-sm font-bold px-4 py-1.5 rounded-full shadow-sm border ${isPhysicallyFull ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-teal-800 border-teal-100'}`}>
                            {totalPresents} / {capacity} places
                        </span>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        {slotsRender.map((slot, index) => {
                            if (slot.type === 'titulaire') {
                                const eleve = slot.student;
                                const isMe = eleve.id === myId;
                                const status = attendanceData.status?.[eleve.id];
                                const isPresent = status === 'present' || status === undefined;
                                const isAbsent = !isPresent;
                                const replacementId = Object.keys(replacementLinks).find(k => replacementLinks[k] === eleve.id);
                                const replacement = replacementId ? invites.find(i => i.id === replacementId) : null;
                                const cannotReclaim = isMe && isAbsent && isPhysicallyFull;
                                let borderClass = isPresent ? 'border-teal-500' : 'border-red-300 bg-red-50/20';
                                if (isMe) borderClass += " ring-2 ring-teal-200";

                                return (
                                    <div key={eleve.id} className={`relative p-4 rounded-xl border-l-4 shadow-sm bg-white transition-all ${borderClass} ${isPast ? 'opacity-80' : ''}`}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="font-bold text-gray-800 text-lg flex items-center gap-2">
                                                    {eleve.prenom} {eleve.nom.charAt(0)}.
                                                    {isMe && <span className="bg-teal-100 text-teal-800 text-[10px] px-1.5 py-0.5 rounded uppercase">Moi</span>}
                                                </div>
                                                <div className="text-[10px] uppercase font-bold text-gray-400 mb-2 tracking-wide">Titulaire</div>
                                                {isMe && !processing && !isPast && (
                                                    <div className="group relative inline-block">
                                                        <button onClick={toggleMyPresence} disabled={cannotReclaim} className={`text-xs px-3 py-1 rounded font-bold border transition ${cannotReclaim ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed' : (isPresent ? 'bg-teal-50 text-teal-700 border-teal-200 hover:bg-teal-100' : 'bg-white text-red-500 border-red-200 shadow-sm hover:bg-red-50')}`}>
                                                            {cannotReclaim ? "Place prise" : (isPresent ? "Je m'absente" : "Je viens")}
                                                        </button>
                                                    </div>
                                                )}
                                                {!isMe && (
                                                    <div className="text-right">
                                                        <span className={`block text-xs font-bold ${isPresent ? 'text-teal-600' : 'text-red-400'}`}>{isPresent ? 'Pr√©sent' : 'Absent'}</span>
                                                        {!isPresent && !replacement && !myStatus && !processing && !isTitulaire && !isPast && (
                                                            <button onClick={(e) => { e.stopPropagation(); bookSpot(); }} className="mt-1.5 bg-purple-600 text-white text-[10px] px-3 py-1.5 rounded-lg font-bold hover:bg-purple-700 shadow-md flex items-center gap-1"><span>‚ö° Remplacer</span></button>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        {replacement && (
                                            <div className="mt-3 pt-3 border-t border-purple-100 flex justify-between items-center text-purple-700">
                                                <div className="flex items-center gap-2"><span className="text-xl">‚Ü≥</span><span className="font-bold text-sm block">{replacement.prenom} {replacement.nom.charAt(0)}. {replacement.id === myId && " (Moi)"}</span></div>
                                                {replacement.id === myId && !processing && !isPast && <button onClick={(e) => { e.stopPropagation(); cancelBooking(); }} className="text-xs bg-white text-red-500 border border-red-200 px-2 py-1 rounded">Annuler</button>}
                                            </div>
                                        )}
                                    </div>
                                );
                            }
                            if (slot.type === 'guest_in_slot') {
                                const eleve = slot.student;
                                const isMe = eleve.id === myId;
                                return (
                                    <div key={eleve.id} className={`p-4 rounded-xl border-l-4 border-purple-500 bg-purple-50 shadow-sm flex justify-between items-center ${isMe ? 'ring-2 ring-purple-200' : ''} ${isPast ? 'opacity-80' : ''}`}>
                                        <div><div className="font-bold text-gray-800 text-lg">{eleve.prenom} {eleve.nom.charAt(0)}. {isMe && <span className="ml-2 bg-purple-200 text-purple-800 text-[10px] px-1.5 py-0.5 rounded uppercase">Moi</span>}</div><div className="text-[10px] uppercase font-bold text-purple-600 tracking-wide">{isExceptionnel ? "Participant" : "Invit√©"}</div></div>
                                        {isMe && !processing && !isPast && <button onClick={cancelBooking} className="text-xs bg-white border border-red-200 text-red-500 px-2 py-1 rounded">Annuler</button>}
                                    </div>
                                );
                            }
                            return (
                                <div key={`empty-${index}`} className={`relative p-4 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 flex flex-col justify-center items-center min-h-[100px] group transition-all ${isPast ? 'opacity-50' : 'hover:border-teal-400 hover:bg-white'}`}>
                                    <div className="text-gray-400 text-xs font-bold uppercase mb-2 tracking-widest group-hover:text-teal-600">Place Libre</div>
                                    {!isTitulaire && !myStatus && !processing && !isPast && <button onClick={bookSpot} className="px-6 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-600 hover:text-white hover:bg-teal-600 hover:border-teal-600 shadow-sm transition">R√©server</button>}
                                </div>
                            );
                        })}
                    </div>

                    {overflowGuests.length > 0 && (
                        <div className="mt-8 border-t pt-6 border-gray-200">
                            <h3 className="text-xs font-bold text-red-600 uppercase mb-3">‚ö†Ô∏è Surnombre</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {overflowGuests.map(eleve => (
                                    <div key={eleve.id} className="p-3 rounded-lg border border-red-200 bg-red-50 flex justify-between items-center shadow-sm">
                                        <div className="flex items-center gap-3"><span className="text-red-500 font-bold text-xl">+</span><span className="text-sm font-bold text-gray-800">{eleve.prenom} {eleve.nom.charAt(0)}. {eleve.id === myId && "(Moi)"}</span></div>
                                        {eleve.id === myId && !isPast && <button onClick={cancelBooking} className="text-xs bg-white border border-red-200 text-red-500 px-2 py-1 rounded">Annuler</button>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="mt-8 bg-orange-50 rounded-xl border border-orange-200 p-5 shadow-sm">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-xs font-bold text-orange-800 uppercase flex items-center gap-2">üïí Liste d'attente ({attendanceData.waitingList?.length || 0})</h3></div>
                        <div className="space-y-2">
                            {attendanceData.waitingList?.map(uid => {
                                const eleve = allEleves.find(e => e.id === uid);
                                if (!eleve) return null;
                                const isMe = uid === myId;
                                return (
                                    <div key={uid} className={`p-3 rounded-lg border flex justify-between items-center shadow-sm ${isMe ? 'bg-orange-100 border-orange-300' : 'bg-white border-orange-100'}`}>
                                        <span className={`text-sm font-medium ${isMe ? 'text-orange-900' : 'text-gray-800'}`}>{eleve.prenom} {eleve.nom.charAt(0)}. {isMe && <span className="ml-2 font-bold text-xs uppercase">(Moi)</span>}</span>
                                        {isMe && !processing && !isPast && <button onClick={toggleWaitlist} className="text-xs text-orange-600 hover:text-red-600 hover:bg-white px-2 py-1 rounded border border-transparent hover:border-gray-200 transition">Quitter</button>}
                                    </div>
                                )
                            })}
                            {(!attendanceData.waitingList || attendanceData.waitingList.length === 0) && <p className="text-xs text-orange-300 italic text-center py-2">Vide.</p>}
                        </div>
                        {/* BOUTON LISTE D'ATTENTE : S'affiche si complet et pas d√©j√† inscrit */}
                        {!isTitulaire && !myStatus && !isInWaitingList && isPhysicallyFull && !isPast && (
                            <div className="mt-4 pt-4 border-t border-orange-200 text-center">
                                <button onClick={toggleWaitlist} className="w-full md:w-auto bg-orange-400 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-500 shadow-md transition">M'ajouter √† la liste d'attente</button>
                            </div>
                        )}
                    </div>
                </div>

                <div className="p-5 bg-white border-t flex justify-end gap-4 z-40">
                    <button onClick={onClose} className="px-5 py-2.5 text-gray-500 font-bold hover:bg-gray-100 rounded-lg transition">Fermer</button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/GestionSeance.jsx">
import { useState, useEffect, useRef } from 'react';
import { db } from './firebase';
import {
    collection,
    getDocs,
    doc,
    getDoc,
    writeBatch,
    increment,
    updateDoc,
    arrayUnion,
    arrayRemove,
    serverTimestamp,
    Timestamp,
    deleteField,
    addDoc,
    deleteDoc,
    query,
    where
} from 'firebase/firestore';
import toast from 'react-hot-toast';
import ConfirmModal from './components/ConfirmModal';

export default function GestionSeance({ groupe, date, onClose, onEdit }) {
    // --- √âTATS ---
    const [inscrits, setInscrits] = useState([]);
    const [invites, setInvites] = useState([]);
    const [waitingList, setWaitingList] = useState([]);
    const [allStudents, setAllStudents] = useState([]);

    const [statuses, setStatuses] = useState({});
    const [initialStatus, setInitialStatus] = useState({});

    // Liens : { [guestId]: titulaireId }
    const [replacementLinks, setReplacementLinks] = useState({});
    // Origines : { [guestId]: 'waiting' | 'manual' }
    const [guestOrigins, setGuestOrigins] = useState({});

    const [loading, setLoading] = useState(true);
    const [estAnnule, setEstAnnule] = useState(false);
    const [annulationDocId, setAnnulationDocId] = useState(null);

    // √âtat pour la modale de confirmation
    const [confirmConfig, setConfirmConfig] = useState(null);
    const motifRef = useRef(""); // R√©f√©rence pour le motif d'annulation

    // --- S√âLECTEURS ---
    const [addMode, setAddMode] = useState(null);
    const [targetSlotId, setTargetSlotId] = useState(null);
    const [selectedStudentId, setSelectedStudentId] = useState("");
    const [selectedWaitlistId, setSelectedWaitlistId] = useState("");

    const isExceptionnel = groupe.type === 'ajout';

    // FORMATAGE DE L'ID
    const dateStr = date.toLocaleDateString('fr-CA');
    const seanceId = isExceptionnel ? groupe.id : `${dateStr}_${groupe.id}`;

    useEffect(() => {
        chargerDonnees();
    }, []);

    const chargerDonnees = async () => {
        try {
            // 1. V√©rif Annulation
            if (!isExceptionnel) {
                const q = query(
                    collection(db, "exceptions"),
                    where("groupeId", "==", groupe.id),
                    where("date", "==", dateStr),
                    where("type", "==", "annulation")
                );
                const exSnap = await getDocs(q);
                if (!exSnap.empty) {
                    setEstAnnule(true);
                    setAnnulationDocId(exSnap.docs[0].id);
                } else {
                    setEstAnnule(false);
                    setAnnulationDocId(null);
                }
            }

            // 2. Charger TOUS les √©l√®ves
            const elevesSnapshot = await getDocs(collection(db, "eleves"));
            const tous = elevesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            tous.sort((a, b) => a.nom.localeCompare(b.nom));
            setAllStudents(tous);

            // 3. Charger l'Attendance
            const attendanceDoc = await getDoc(doc(db, "attendance", seanceId));

            let savedStatus = {};
            let savedReplacementLinks = {};
            let savedGuestOrigins = {};
            let savedWaitingIds = [];

            if (attendanceDoc.exists()) {
                const data = attendanceDoc.data();
                savedStatus = data.status || {};
                savedReplacementLinks = data.replacementLinks || {};
                savedGuestOrigins = data.guestOrigins || {};
                savedWaitingIds = data.waitingList || [];
            }

            // A. Identification des TITULAIRES
            const listeInscrits = isExceptionnel
                ? []
                : tous.filter(e => e.enrolledGroupIds && e.enrolledGroupIds.includes(groupe.id));

            // B. Identification des INVIT√âS
            const presentIds = Object.keys(savedStatus).filter(k => savedStatus[k] === 'present');
            const guestIds = presentIds.filter(pid => !listeInscrits.some(i => i.id === pid));

            const listeInvites = guestIds.map(id => {
                const found = tous.find(s => s.id === id);
                return found || { id: id, nom: 'Inconnu', prenom: 'Utilisateur', absARemplacer: 0 };
            });

            // C. File d'attente
            const listeAttente = savedWaitingIds.map(id => tous.find(s => s.id === id)).filter(Boolean);

            setInscrits(listeInscrits);
            setInvites(listeInvites);
            setWaitingList(listeAttente);
            setReplacementLinks(savedReplacementLinks);
            setGuestOrigins(savedGuestOrigins);

            const finalStatus = { ...savedStatus };
            setStatuses(finalStatus);
            setInitialStatus(JSON.parse(JSON.stringify(finalStatus)));

        } catch (error) {
            console.error("Erreur chargement:", error);
            toast.error("Erreur chargement donn√©es");
        } finally {
            setLoading(false);
        }
    };

    // --- ACTIONS ADMIN ---

    const triggerConfirm = (title, content, action, colorClass = "bg-red-500", confirmLabel = "Confirmer") => {
        setConfirmConfig({
            title,
            content, // Content peut maintenant √™tre du JSX
            colorClass,
            confirmLabel,
            onConfirm: async () => {
                await action();
                setConfirmConfig(null);
            }
        });
    };

    const handleAnnulerUnique = async () => {
        motifRef.current = ""; // Reset du motif
        // On passe du JSX dans le content pour inclure l'input
        const contentJsx = (
            <div className="space-y-3">
                <p className="text-gray-600 text-sm">Les √©l√®ves ne verront plus ce cours.</p>
                <div>
                    <label className="block text-xs font-bold text-gray-500 mb-1">Motif (optionnel)</label>
                    <input
                        type="text"
                        placeholder="ex: Vacances, Maladie, F√©ri√©..."
                        className="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-red-200 outline-none"
                        onChange={(e) => motifRef.current = e.target.value}
                    />
                </div>
            </div>
        );

        triggerConfirm("Annuler la s√©ance ?", contentJsx, async () => {
            setLoading(true);
            await addDoc(collection(db, "exceptions"), {
                date: dateStr,
                groupeId: groupe.id,
                type: "annulation",
                motif: motifRef.current // Enregistrement du motif
            });
            await chargerDonnees();
            toast.success("S√©ance annul√©e");
        }, "bg-red-600", "Annuler la s√©ance");
    };

    const handleRetablir = async () => {
        // Pour r√©tablir, on passe juste du texte simple
        triggerConfirm("R√©tablir la s√©ance ?", <p className="text-gray-600 text-sm">Le cours r√©appara√Ætra dans le planning.</p>, async () => {
            setLoading(true);
            await deleteDoc(doc(db, "exceptions", annulationDocId));
            await chargerDonnees();
            toast.success("S√©ance r√©tablie");
        }, "bg-green-600", "R√©tablir");
    };

    const handleSupprimerDefinitif = async () => {
        const msg = isExceptionnel ? "Supprimer cette s√©ance unique ?" : "Supprimer TOUT le cours r√©current ?";
        triggerConfirm("Suppression D√©finitive", <p className="text-gray-600 text-sm">{msg}</p>, async () => {
            setLoading(true);
            const collectionName = isExceptionnel ? "exceptions" : "groupes";
            const docId = isExceptionnel ? (groupe.originalExceptionId || groupe.id) : groupe.id;
            await deleteDoc(doc(db, collectionName, docId));
            onClose();
            window.location.reload();
        }, "bg-red-700", "Supprimer d√©finitivement");
    };

    // --- LOGIQUE PRESENCE ---
    const toggleStatus = (eleveId) => {
        const currentStatus = statuses[eleveId];
        const isCurrentlyAbsent = currentStatus === 'absent' || currentStatus === 'absent_announced';
        const newStatus = isCurrentlyAbsent ? 'present' : 'absent';

        if (newStatus === 'present') {
            const nbPresents = inscrits.filter(i => {
                if (i.id === eleveId) return true;
                const s = statuses[i.id];
                return s !== 'absent' && s !== 'absent_announced';
            }).length + invites.length;

            const placesTotales = typeof groupe.places === 'number' ? groupe.places : 10;

            if (nbPresents > placesTotales) {
                if (!confirm(`‚ö†Ô∏è Cours complet (${placesTotales} places).\nAjouter en SURNOMBRE ?`)) return;
            }

            const guestIdLinked = Object.keys(replacementLinks).find(key => replacementLinks[key] === eleveId);
            if (guestIdLinked) {
                const newLinks = { ...replacementLinks };
                delete newLinks[guestIdLinked];
                setReplacementLinks(newLinks);
            }
        }
        setStatuses(prev => ({ ...prev, [eleveId]: newStatus }));
    };

    const preparerAjout = (mode, targetId = null) => {
        setAddMode(mode);
        setTargetSlotId(targetId);
        setSelectedStudentId("");
    };

    const validerAjout = async () => {
        if (!selectedStudentId) return;
        const eleve = allStudents.find(e => e.id === selectedStudentId);
        if (!eleve) return;

        if (addMode === 'permanent') {
            if (isExceptionnel) { toast.error("Impossible sur s√©ance unique."); return; }
            triggerConfirm("Inscription Annuelle", <p className="text-gray-600 text-sm">Inscrire {eleve.prenom} d√©finitivement √† ce cr√©neau ?</p>, async () => {
                await updateDoc(doc(db, "eleves", eleve.id), { enrolledGroupIds: arrayUnion(groupe.id) });
                chargerDonnees();
                setAddMode(null);
                toast.success("Inscrit √† l'ann√©e !");
            }, "bg-teal-600", "Inscrire");
            return;
        }

        const vientDeFileAttente = waitingList.find(w => w.id === eleve.id);
        if (vientDeFileAttente) {
            setWaitingList(prev => prev.filter(w => w.id !== eleve.id));
            setGuestOrigins(prev => ({ ...prev, [eleve.id]: 'waiting' }));
        } else {
            setGuestOrigins(prev => ({ ...prev, [eleve.id]: 'manual' }));
        }

        setInvites(prev => [...prev, eleve]);
        setStatuses(prev => ({ ...prev, [eleve.id]: 'present' }));

        if (addMode === 'replace' && targetSlotId) {
            setReplacementLinks(prev => ({ ...prev, [eleve.id]: targetSlotId }));
        }

        setAddMode(null);
        setTargetSlotId(null);
        setSelectedStudentId("");
        toast.success("Invit√© ajout√©");
    };

    const desinscrireTitulaire = (eleve) => {
        triggerConfirm("D√©sinscrire ce titulaire ?",
            <p className="text-gray-600 text-sm">Cela retirera {eleve.prenom} de la liste des inscrits √† l'ann√©e pour ce cours.</p>,
            async () => {
                const batch = writeBatch(db);
                batch.update(doc(db, "eleves", eleve.id), { enrolledGroupIds: arrayRemove(groupe.id) });
                batch.update(doc(db, "attendance", seanceId), {
                    [`status.${eleve.id}`]: deleteField(),
                    [`replacementLinks.${eleve.id}`]: deleteField()
                });
                await batch.commit();

                const newStatuses = { ...statuses };
                delete newStatuses[eleve.id];
                setStatuses(newStatuses);
                setInscrits(prev => prev.filter(i => i.id !== eleve.id));
                toast.success("Titulaire d√©sinscrit");
            },
            "bg-red-600", "D√©sinscrire"
        );
    };

    const retirerInvite = (eleveId) => {
        const origine = guestOrigins[eleveId];
        const msg = origine === 'waiting' ? "Retourner en file d'attente ?" : "Retirer de la s√©ance ?";

        triggerConfirm("Retirer l'invit√© ?", <p className="text-gray-600 text-sm">{msg}</p>, async () => {
            const eleve = invites.find(i => i.id === eleveId);
            setInvites(prev => prev.filter(e => e.id !== eleveId));

            const newStatuses = { ...statuses };
            delete newStatuses[eleveId];
            setStatuses(newStatuses);

            const newLinks = { ...replacementLinks };
            delete newLinks[eleveId];
            setReplacementLinks(newLinks);

            if (origine === 'waiting' && eleve && !waitingList.some(w => w.id === eleve.id)) {
                setWaitingList(prev => [...prev, eleve]);
            }
            toast.success("Invit√© retir√©");
        }, "bg-orange-500", "Retirer");
    };

    // --- LOGIQUE FILE D'ATTENTE ---
    const ajouterAuWaitingList = () => {
        if (!selectedWaitlistId) return;
        const eleve = allStudents.find(e => e.id === selectedWaitlistId);
        if (eleve && !waitingList.find(w => w.id === eleve.id)) {
            setWaitingList(prev => [...prev, eleve]);
            setSelectedWaitlistId("");
            toast.success("Ajout√© √† la file d'attente");
        }
    };

    const supprimerDuWaitingList = (id) => setWaitingList(prev => prev.filter(w => w.id !== id));

    const integrerDepuisFileAttente = (eleve) => {
        const titulaireAbsentDispo = inscrits.find(t => {
            const estAbsent = statuses[t.id] === 'absent' || statuses[t.id] === 'absent_announced';
            const aDejaRemplacant = Object.values(replacementLinks).includes(t.id);
            return estAbsent && !aDejaRemplacant;
        });

        setWaitingList(prev => prev.filter(w => w.id !== eleve.id));
        setGuestOrigins(prev => ({ ...prev, [eleve.id]: 'waiting' }));
        setInvites(prev => [...prev, eleve]);
        setStatuses(prev => ({ ...prev, [eleve.id]: 'present' }));

        if (titulaireAbsentDispo) {
            setReplacementLinks(prev => ({ ...prev, [eleve.id]: titulaireAbsentDispo.id }));
        }
        toast.success(`${eleve.prenom} int√©gr√© !`);
    };

    const forcerDepuisFileAttente = (eleve) => {
        setWaitingList(prev => prev.filter(w => w.id !== eleve.id));
        setGuestOrigins(prev => ({ ...prev, [eleve.id]: 'waiting' }));
        setInvites(prev => [...prev, eleve]);
        setStatuses(prev => ({ ...prev, [eleve.id]: 'present' }));
        toast.success(`${eleve.prenom} ajout√© en surnombre`);
    };

    const sauvegarder = async () => {
        setLoading(true);
        try {
            const batch = writeBatch(db);
            const ref = doc(db, "attendance", seanceId);
            const statusToSave = { ...statuses };

            Object.keys(initialStatus).forEach(id => {
                if (statuses[id] === undefined) statusToSave[id] = deleteField();
            });

            batch.set(ref, {
                date: dateStr,
                groupeId: groupe.id,
                nomGroupe: groupe.nom,
                realDate: Timestamp.fromDate(date),
                status: statusToSave,
                waitingList: waitingList.map(e => e.id),
                replacementLinks: replacementLinks,
                guestOrigins: guestOrigins,
                updatedAt: serverTimestamp()
            }, { merge: true });

            // Mise √† jour des cr√©dits
            const allIds = new Set([...Object.keys(initialStatus), ...Object.keys(statuses)]);
            allIds.forEach(eid => {
                const studentExists = allStudents.find(s => s.id === eid);
                if (!studentExists) return;

                const oldS = initialStatus[eid];
                const newS = statuses[eid];
                const finalNew = newS || 'removed';

                if (oldS === finalNew) return;

                const isTitulaire = inscrits.some(e => e.id === eid);
                let change = 0;

                if (isTitulaire) {
                    if (finalNew === 'absent' && oldS !== 'absent') change = 1;
                    else if (finalNew === 'present' && oldS === 'absent') change = -1;
                } else {
                    if (finalNew === 'present' && oldS !== 'present') change = -1;
                    else if (finalNew !== 'present' && oldS === 'present') change = 1;
                }

                if (change !== 0) {
                    if (isExceptionnel) {
                        // MODIFICATION : Pas d'impact sur le solde si s√©ance exceptionnelle
                        const histRef = doc(collection(db, "eleves", eid, "history"));
                        batch.set(histRef, {
                            date: serverTimestamp(),
                            delta: 0, // Delta 0 pour info seulement
                            motif: `Modif Prof (Exceptionnel) : ${groupe.nom}`,
                            seanceId: seanceId,
                            groupeNom: groupe.nom,
                            seanceDate: dateStr
                        });
                    } else {
                        // Comportement STANDARD
                        batch.update(doc(db, "eleves", eid), { absARemplacer: increment(change) });
                        const histRef = doc(collection(db, "eleves", eid, "history"));
                        batch.set(histRef, {
                            date: serverTimestamp(),
                            delta: change,
                            motif: `Modif Prof : ${groupe.nom}`,
                            seanceId: seanceId,
                            groupeNom: groupe.nom,
                            seanceDate: dateStr
                        });
                    }
                }
            });

            await batch.commit();
            toast.success("Sauvegard√© !");
            onClose();
        } catch (e) { console.error(e); toast.error("Erreur sauvegarde"); }
        finally { setLoading(false); }
    };

    // --- RENDER ---
    const capacity = typeof groupe.places === 'number' ? groupe.places : 10;
    const nbTitulairesPresents = inscrits.filter(i => {
        const s = statuses[i.id];
        return s !== 'absent' && s !== 'absent_announced';
    }).length;

    const nbInvites = invites.length;
    const totalPresents = nbTitulairesPresents + nbInvites;
    const realFreeSlots = capacity - totalPresents;

    const validTitulaireIds = inscrits.map(t => t.id);
    const linkedGuestIds = Object.keys(replacementLinks).filter(guestId => {
        return validTitulaireIds.includes(replacementLinks[guestId]);
    });
    const freeGuests = invites.filter(i => !linkedGuestIds.includes(i.id));

    const slotsRender = [];
    if (!isExceptionnel) {
        inscrits.forEach(titulaire => slotsRender.push({ type: 'titulaire', student: titulaire }));
    }
    const baseOccupied = isExceptionnel ? 0 : inscrits.length;
    const slotsAvailableForGuests = Math.max(0, capacity - baseOccupied);

    for (let i = 0; i < slotsAvailableForGuests; i++) {
        if (i < freeGuests.length) slotsRender.push({ type: 'guest_in_slot', student: freeGuests[i] });
        else slotsRender.push({ type: 'empty' });
    }
    const overflowGuests = freeGuests.slice(slotsAvailableForGuests);

    // --- MODALE S√âLECTION √âL√àVE ---
    const RenderSelector = () => {
        const waitingIds = waitingList.map(w => w.id);
        const availableStudents = allStudents.filter(s =>
            !inscrits.find(i => i.id === s.id) &&
            !invites.find(i => i.id === s.id)
        );
        const priorityList = availableStudents.filter(s => waitingIds.includes(s.id));
        const standardList = availableStudents.filter(s => !waitingIds.includes(s.id));

        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-[1px]" onClick={() => setAddMode(null)}>
                <div className="bg-white p-6 rounded-xl shadow-2xl border-2 border-teal-500 w-96" onClick={e => e.stopPropagation()}>
                    <h4 className="text-lg font-bold text-teal-800 mb-4 uppercase flex justify-between items-center border-b pb-2">
                        {addMode === 'permanent' ? "Inscrire √† l'ann√©e" : "Ajouter un participant"}
                        <button onClick={() => setAddMode(null)} className="text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
                    </h4>
                    <select autoFocus className="w-full text-base border-gray-300 border p-3 rounded-lg mb-6 outline-none" value={selectedStudentId} onChange={e => setSelectedStudentId(e.target.value)}>
                        <option value="">-- S√©lectionner --</option>
                        {priorityList.length > 0 && (
                            <optgroup label="üïí Sur File d'Attente">
                                {priorityList.map(s => <option key={s.id} value={s.id}>üïí {s.nom} {s.prenom} ({s.absARemplacer} Cr.)</option>)}
                            </optgroup>
                        )}
                        <optgroup label="üë• Autres √©l√®ves">
                            {standardList.map(s => <option key={s.id} value={s.id}>{s.nom} {s.prenom} ({s.absARemplacer} Cr.)</option>)}
                        </optgroup>
                    </select>
                    <div className="flex gap-3 justify-end">
                        <button onClick={() => setAddMode(null)} className="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-bold">Annuler</button>
                        <button onClick={validerAjout} disabled={!selectedStudentId} className="px-6 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700">Valider</button>
                    </div>
                </div>
            </div>
        );
    };

    if (loading) return <div className="fixed inset-0 bg-black/80 flex items-center justify-center text-white z-50">Chargement...</div>;

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            {addMode && <RenderSelector />}
            <ConfirmModal
                isOpen={!!confirmConfig}
                title={confirmConfig?.title}
                confirmLabel={confirmConfig?.confirmLabel}
                colorClass={confirmConfig?.colorClass}
                onConfirm={confirmConfig?.onConfirm}
                onCancel={() => setConfirmConfig(null)}
            >
                {confirmConfig?.content}
            </ConfirmModal>

            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[95vh] relative">
                {/* HEADER */}
                <div className={`p-6 text-white flex justify-between items-start ${estAnnule ? 'bg-gray-600' : (isExceptionnel ? 'bg-purple-700' : 'bg-teal-900')}`}>
                    <div className="flex-1">
                        <div className="flex items-center gap-2">
                            <h2 className="text-2xl font-bold font-playfair">{groupe.nom} {estAnnule && "(ANNUL√â)"}</h2>
                            {isExceptionnel && <span className="text-[10px] bg-white/20 px-2 py-0.5 rounded uppercase font-bold tracking-wider">S√©ance Unique</span>}
                        </div>
                        <div className="mt-1">
                            <p className="text-teal-100 text-sm capitalize">{date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })} ‚Ä¢ {groupe.heureDebut}</p>
                            {groupe.theme && <p className="text-sm italic text-yellow-200 mt-1 border-l-2 border-yellow-200 pl-2">Th√®me : "{groupe.theme}"</p>}
                        </div>
                        <div className="flex gap-2 mt-4 flex-wrap">
                            {onEdit && <button onClick={() => onEdit(groupe)} className="bg-white text-purple-800 px-3 py-1.5 rounded-lg text-xs font-bold shadow-md hover:bg-gray-100 transition flex items-center gap-2">‚úèÔ∏è Modifier</button>}
                            {!isExceptionnel && !estAnnule && <button onClick={handleAnnulerUnique} className="bg-red-500/80 hover:bg-red-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-md transition flex items-center gap-2 border border-red-400">üö´ Annuler cette s√©ance</button>}
                            {!isExceptionnel && estAnnule && <button onClick={handleRetablir} className="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-md transition flex items-center gap-2">‚úÖ R√©tablir la s√©ance</button>}
                        </div>
                    </div>
                    <button onClick={onClose} className="bg-white/20 hover:bg-white/40 rounded-full w-10 h-10 flex items-center justify-center font-bold">‚úï</button>
                </div>

                {/* CONTENU */}
                <div className="flex-1 overflow-y-auto p-6 bg-gray-100 relative">
                    {estAnnule && (
                        <div className="absolute inset-0 bg-white/60 z-10 flex items-center justify-center backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl shadow-2xl text-center border-2 border-red-100">
                                <h3 className="text-xl font-bold text-gray-800 mb-2">S√©ance Annul√©e</h3>
                                <button onClick={handleRetablir} className="bg-teal-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-teal-700">R√©tablir</button>
                            </div>
                        </div>
                    )}

                    {!estAnnule && (
                        <div className="flex justify-between items-center mb-6 px-2">
                            <span className="text-xs font-bold uppercase text-gray-500 tracking-wider">Remplissage</span>
                            <span className={`text-sm font-bold px-4 py-1.5 rounded-full shadow-sm border ${totalPresents > capacity ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-teal-800 border-teal-100'}`}>
                                {totalPresents} / {capacity} places
                            </span>
                        </div>
                    )}

                    {/* GRILLE */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        {slotsRender.map((slot, index) => {
                            if (slot.type === 'titulaire') {
                                const eleve = slot.student;
                                const status = statuses[eleve.id];
                                const isPresent = status === 'present' || status === undefined;
                                const replacementId = Object.keys(replacementLinks).find(k => replacementLinks[k] === eleve.id);
                                const replacement = replacementId ? invites.find(i => i.id === replacementId) : null;

                                return (
                                    <div key={eleve.id} className={`relative p-4 rounded-xl border-l-4 shadow-sm bg-white transition-all ${isPresent ? 'border-teal-500' : 'border-red-300 bg-red-50/20'}`}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="font-bold text-gray-800 text-lg">{eleve.prenom} {eleve.nom}</div>
                                                <div className="text-[10px] uppercase font-bold text-gray-400 mb-2 tracking-wide">Titulaire</div>
                                            </div>
                                            {/* BOUTONS ADMIN */}
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => toggleStatus(eleve.id)} className={`text-xs px-3 py-1 rounded font-bold border transition ${isPresent ? 'bg-teal-50 text-teal-700 border-teal-200' : 'bg-white text-red-500 border-red-200 shadow-sm'}`}>
                                                    {isPresent ? 'Pr√©sent' : 'Absent'}
                                                </button>
                                                {!isPresent && !replacement && (
                                                    <button onClick={() => preparerAjout('replace', eleve.id)} className="w-8 h-8 rounded-full bg-purple-100 text-purple-600 hover:bg-purple-200 flex items-center justify-center font-bold border border-purple-200" title="Remplacer">+</button>
                                                )}
                                                <button onClick={() => desinscrireTitulaire(eleve)} className="text-gray-300 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50" title="D√©sinscrire">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        {replacement && (
                                            <div className="mt-3 pt-3 border-t border-purple-100 flex justify-between items-center text-purple-700">
                                                <div className="flex items-center gap-2"><span className="text-xl">‚Ü≥</span><span className="font-bold text-sm block">{replacement.prenom} {replacement.nom}</span><span className="text-[9px] bg-purple-100 px-1.5 py-0.5 rounded uppercase font-bold">Rempla√ßant</span></div>
                                                <button onClick={() => retirerInvite(replacement.id)} className="text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center">‚úï</button>
                                            </div>
                                        )}
                                    </div>
                                );
                            }
                            if (slot.type === 'guest_in_slot') {
                                const eleve = slot.student;
                                return (
                                    <div key={eleve.id} className="p-4 rounded-xl border-l-4 border-purple-500 bg-purple-50 shadow-sm flex justify-between items-center">
                                        <div><div className="font-bold text-gray-800 text-lg">{eleve.prenom} {eleve.nom}</div><div className="text-[10px] uppercase font-bold text-purple-600 tracking-wide">{isExceptionnel ? "Participant" : "Invit√© (Ponctuel)"}</div></div>
                                        <button onClick={() => retirerInvite(eleve.id)} className="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-500 rounded-full hover:bg-white transition">‚úï</button>
                                    </div>
                                );
                            }
                            return (
                                <div key={`empty-${index}`} className="relative p-4 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 flex flex-col justify-center items-center min-h-[110px] group hover:border-teal-400 hover:bg-white transition-all">
                                    <div className="text-gray-400 text-xs font-bold uppercase mb-3 tracking-widest group-hover:text-teal-600">Place Libre</div>
                                    <div className="flex gap-3 relative">
                                        {!isExceptionnel && <button onClick={() => preparerAjout('permanent')} className="px-4 py-1.5 bg-white border border-gray-300 rounded-lg text-xs font-bold text-gray-600 hover:text-teal-700 hover:border-teal-500 shadow-sm transition">üë§ Titulaire</button>}
                                        <button onClick={() => preparerAjout('guest')} className={`px-4 py-1.5 bg-white border border-gray-300 rounded-lg text-xs font-bold text-gray-600 hover:text-purple-700 hover:border-purple-500 shadow-sm transition ${isExceptionnel ? 'w-full' : ''}`}>{isExceptionnel ? "‚ûï Ajouter un participant" : "üéüÔ∏è Invit√©"}</button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* SURNOMBRE */}
                    {overflowGuests.length > 0 && (
                        <div className="mt-8 border-t pt-6 border-gray-200">
                            <h3 className="text-xs font-bold text-red-600 uppercase mb-3 flex items-center gap-2">‚ö†Ô∏è Surnombre (Hors Capacit√©)</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {overflowGuests.map(eleve => (
                                    <div key={eleve.id} className="p-3 rounded-lg border border-red-200 bg-red-50 flex justify-between items-center shadow-sm">
                                        <div className="flex items-center gap-3"><span className="text-red-500 font-bold text-xl">+</span><span className="text-sm font-bold text-gray-800">{eleve.prenom} {eleve.nom}</span></div>
                                        <button onClick={() => retirerInvite(eleve.id)} className="text-red-400 hover:text-red-700 font-bold px-2 py-1 hover:bg-red-100 rounded transition">‚úï</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* FILE D'ATTENTE */}
                    <div className="mt-8 bg-orange-50 rounded-xl border border-orange-200 p-5 shadow-sm">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xs font-bold text-orange-800 uppercase flex items-center gap-2 tracking-wide">üïí Liste d'attente ({waitingList.length || 0})</h3>
                            <div className="flex gap-2">
                                <select className="text-xs border-orange-200 rounded-lg bg-white py-2 pl-2 pr-8 outline-none" value={selectedWaitlistId} onChange={e => setSelectedWaitlistId(e.target.value)}>
                                    <option value="">+ Ajouter</option>
                                    {allStudents.filter(s => !inscrits.find(i => i.id === s.id) && !invites.find(i => i.id === s.id) && !waitingList.find(w => w.id === s.id)).map(s => <option key={s.id} value={s.id}>{s.nom} {s.prenom}</option>)}
                                </select>
                                <button onClick={ajouterAuWaitingList} disabled={!selectedWaitlistId} className="bg-orange-400 text-white px-3 rounded-lg font-bold text-lg hover:bg-orange-500 shadow-sm">+</button>
                            </div>
                        </div>
                        <div className="space-y-2">
                            {waitingList.map(eleve => (
                                <div key={eleve.id} className="bg-white p-3 rounded-lg border border-orange-100 flex justify-between items-center shadow-sm">
                                    <span className="text-sm font-medium text-gray-800">{eleve.prenom} {eleve.nom}</span>
                                    <div className="flex gap-2">
                                        {realFreeSlots > 0 && <button onClick={() => integrerDepuisFileAttente(eleve)} className="text-[10px] bg-green-100 text-green-800 px-3 py-1.5 rounded font-bold hover:bg-green-200 border border-green-200 transition">üì• REMPLACER</button>}
                                        <button onClick={() => forcerDepuisFileAttente(eleve)} className="text-[10px] bg-teal-50 text-teal-800 px-3 py-1.5 rounded font-bold hover:bg-teal-100 border border-teal-200 transition">SURNOMBRE</button>
                                        <button onClick={() => supprimerDuWaitingList(eleve.id)} className="text-gray-400 hover:text-red-500 w-8 flex items-center justify-center hover:bg-red-50 rounded">‚úï</button>
                                    </div>
                                </div>
                            ))}
                            {waitingList.length === 0 && <p className="text-xs text-orange-300 italic text-center py-2">La file d'attente est vide.</p>}
                        </div>
                    </div>
                </div>

                <div className="p-5 bg-white border-t flex justify-between items-center gap-4 z-40">
                    <button onClick={handleSupprimerDefinitif} className="text-gray-300 hover:text-red-600 p-2 text-sm font-bold transition flex items-center gap-1">üóëÔ∏è Supprimer tout</button>
                    <div className="flex gap-4">
                        <button onClick={onClose} className="px-5 py-2.5 text-gray-500 font-bold hover:bg-gray-100 rounded-lg transition">Fermer</button>
                        {!estAnnule && <button onClick={sauvegarder} className="bg-teal-700 text-white px-8 py-2.5 rounded-lg font-bold hover:bg-teal-800 shadow-lg transform active:scale-95 transition">Enregistrer</button>}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/StudentPortal.jsx">
import { useState, useEffect } from 'react';
import { db } from './firebase';
import { Link } from 'react-router-dom';
import { collection, query, where, getDocs, doc, getDoc } from 'firebase/firestore';
import StudentSessionDetail from './StudentSessionDetail';
import Skeleton from './components/Skeleton';
import HistoryModal from './components/HistoryModal';

const JOURS = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];

// --- CONFIGURATION GRILLE ---
const HEURE_DEBUT = 8;
const HEURE_FIN = 21;
const PIXELS_PAR_HEURE = 80;

// --- HELPERS ---
const getLundi = (d) => {
    const date = new Date(d);
    const day = date.getDay();
    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
    date.setDate(diff);
    date.setHours(0, 0, 0, 0);
    return date;
};

const ajouterJours = (date, jours) => {
    const result = new Date(date);
    result.setDate(result.getDate() + jours);
    result.setHours(0, 0, 0, 0);
    return result;
};

const getPlacesLabel = (count) => {
    if (count <= 0) return "Complet";
    if (count === 1) return "1 place";
    return `${count} places`;
};

export default function StudentPortal() {
    const [email, setEmail] = useState('');
    const [student, setStudent] = useState(null);
    const [loading, setLoading] = useState(false);

    // Loading sp√©cifique pour le planning (√©vite de recharger toute la page)
    const [loadingPlanning, setLoadingPlanning] = useState(false);

    const [lundiActuel, setLundiActuel] = useState(getLundi(new Date()));
    const [sessionsSemaine, setSessionsSemaine] = useState([]);
    const [donneesGlobales, setDonneesGlobales] = useState(null);

    const [selectedSession, setSelectedSession] = useState(null);
    const [showHistory, setShowHistory] = useState(false);

    // --- NOUVEAU FILTRE : Voir uniquement mes cours ---
    const [onlyMyCourses, setOnlyMyCourses] = useState(false);

    // --- LOGIN ---
    const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
            const emailClean = email.trim().toLowerCase();
            const q = query(collection(db, "eleves"), where("email", "==", emailClean));
            const snap = await getDocs(q);

            if (snap.empty) { alert("Email inconnu."); setLoading(false); return; }

            const studentData = { id: snap.docs[0].id, ...snap.docs[0].data() };
            setStudent(studentData);

            const [groupsSnap, elevesSnap] = await Promise.all([
                getDocs(query(collection(db, "groupes"), where("actif", "==", true))),
                getDocs(collection(db, "eleves"))
            ]);

            setDonneesGlobales({
                allGroups: groupsSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                allEleves: elevesSnap.docs.map(d => ({ id: d.id, ...d.data() }))
            });

        } catch (err) { console.error(err); } finally { setLoading(false); }
    };

    // --- POSITIONNEMENT ---
    const getCardStyle = (heureDebut, duree) => {
        const [h, m] = heureDebut.split(':').map(Number);
        const minutesDepuisDebut = (h - HEURE_DEBUT) * 60 + m;
        const top = (minutesDepuisDebut / 60) * PIXELS_PAR_HEURE;
        const height = (duree / 60) * PIXELS_PAR_HEURE;
        return { top: `${top}px`, height: `${height}px` };
    };

    // --- CHARGEMENT PLANNING ---
    useEffect(() => {
        if (student && donneesGlobales) {
            calculerPlanningSemaine();
        }
    }, [student, lundiActuel, donneesGlobales]);

    const calculerPlanningSemaine = async () => {
        setLoadingPlanning(true);
        const { allGroups, allEleves } = donneesGlobales;
        const debutSemaineStr = lundiActuel.toLocaleDateString('fr-CA');
        const finSemaine = ajouterJours(lundiActuel, 6);
        const finSemaineStr = finSemaine.toLocaleDateString('fr-CA');

        const [attendanceSnap, exceptionsSnap] = await Promise.all([
            getDocs(query(collection(db, "attendance"), where("date", ">=", debutSemaineStr), where("date", "<=", finSemaineStr))),
            getDocs(collection(db, "exceptions"))
        ]);

        const attendances = attendanceSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        const exceptions = exceptionsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const ajouts = exceptions.filter(ex => ex.type === 'ajout');

        let planning = [];
        const now = new Date(); // Date actuelle pour le calcul "pass√©/futur"

        for (let i = 0; i < 7; i++) {
            const dateDuJour = ajouterJours(lundiActuel, i);
            const jourIndexJS = dateDuJour.getDay();
            const dateStr = dateDuJour.toLocaleDateString('fr-CA');

            // 1. Groupes Hebdomadaires
            const groupesDuJour = allGroups.filter(g => {
                if (g.jour !== jourIndexJS) return false;
                const debut = g.dateDebut?.toDate ? g.dateDebut.toDate() : new Date('2000-01-01');
                const fin = g.dateFin?.toDate ? g.dateFin.toDate() : new Date('2099-12-31');
                debut.setHours(0, 0, 0, 0); fin.setHours(23, 59, 59, 999);
                return dateDuJour >= debut && dateDuJour <= fin;
            });

            // 2. S√©ances Exceptionnelles (Ajouts)
            const ajoutsDuJour = ajouts.filter(a => a.date === dateStr).map(a => ({
                id: a.id,
                ...a.newSessionData,
                isExceptionnel: true,
                type: 'ajout'
            }));

            const tousLesCreneaux = [...groupesDuJour, ...ajoutsDuJour];

            tousLesCreneaux.forEach(groupe => {
                let estAnnule = false;
                let motifAnnulation = "";

                if (!groupe.isExceptionnel) {
                    // MODIF ICI : On r√©cup√®re l'objet exception complet pour avoir le motif
                    const exceptionAnnulation = exceptions.find(ex => ex.groupeId === groupe.id && ex.date === dateStr && ex.type === "annulation");
                    if (exceptionAnnulation) {
                        estAnnule = true;
                        motifAnnulation = exceptionAnnulation.motif || "";
                    }
                }

                const seanceId = groupe.isExceptionnel ? groupe.id : `${dateStr}_${groupe.id}`;
                const attendanceDoc = attendances.find(a => a.id === seanceId);

                const statusMap = attendanceDoc?.status || {};
                const waitingListIds = attendanceDoc?.waitingList || [];

                // --- 1. LISTE DES PR√âSENTS ---
                const recurrentsIds = (!groupe.isExceptionnel)
                    ? allEleves.filter(e => e.enrolledGroupIds && e.enrolledGroupIds.includes(groupe.id)).map(e => e.id)
                    : [];

                const participantsSet = new Set(recurrentsIds);
                Object.entries(statusMap).forEach(([uid, st]) => {
                    if (st === 'absent' || st === 'absent_announced') participantsSet.delete(uid);
                    else if (st === 'present') participantsSet.add(uid);
                });

                const participantsDetails = Array.from(participantsSet)
                    .map(uid => allEleves.find(e => e.id === uid))
                    .filter(Boolean);

                const occupiedCount = participantsDetails.length;
                const placesRestantes = groupe.places - occupiedCount;

                const waitingListDetails = waitingListIds.map(uid => allEleves.find(e => e.id === uid)).filter(Boolean);
                const myStatus = statusMap[student.id];
                const estInscritRecurrent = !groupe.isExceptionnel && student.enrolledGroupIds && student.enrolledGroupIds.includes(groupe.id);

                const isMeAbsent = estInscritRecurrent && (myStatus === 'absent' || myStatus === 'absent_announced');
                const isMeGuest = !estInscritRecurrent && myStatus === 'present';
                const isInWaitingList = waitingListIds.includes(student.id);

                const waitingListPosition = isInWaitingList ? waitingListIds.indexOf(student.id) + 1 : null;

                // --- NOUVEAU : CALCUL SI PASS√â ---
                const [h, m] = groupe.heureDebut.split(':').map(Number);
                const sessionEnd = new Date(dateDuJour);
                sessionEnd.setHours(h, m + (groupe.duree || 60), 0, 0); // On consid√®re pass√© √† la fin du cours
                const isPast = now > sessionEnd;

                planning.push({
                    type: groupe.isExceptionnel ? 'ajout' : 'standard',
                    groupe,
                    dateObj: dateDuJour,
                    dateStr,
                    seanceId,
                    placesRestantes,
                    occupiedCount,
                    estInscritRecurrent,
                    isMeAbsent,
                    isMeGuest,
                    isInWaitingList,
                    waitingListPosition,
                    participantsDetails,
                    waitingListDetails,
                    donneesGlobales,
                    isExceptionnel: !!groupe.isExceptionnel,
                    estAnnule,
                    motifAnnulation, // On transmet le motif
                    isPast
                });
            });
        }

        setSessionsSemaine(planning);
        setLoadingPlanning(false);
    };

    const refreshData = () => {
        setSelectedSession(null);
        setTimeout(() => {
            getDoc(doc(db, "eleves", student.id)).then(snap => {
                setStudent({ id: snap.id, ...snap.data() });
                calculerPlanningSemaine();
            });
        }, 500);
    };

    // --- FILTRAGE FINAL ---
    const sessionsAffichees = onlyMyCourses
        ? sessionsSemaine.filter(s => s.estInscritRecurrent || s.isMeGuest || s.isInWaitingList)
        : sessionsSemaine;

    if (!student) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-teal-50 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                    <h1 className="text-3xl font-playfair font-bold text-teal-800 mb-6 text-center">Espace √âl√®ve üßò</h1>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input type="email" className="w-full border p-3 rounded-lg" placeholder="Votre Email" value={email} onChange={e => setEmail(e.target.value)} required />
                        <button disabled={loading} className="w-full bg-teal-900 text-white font-bold py-3 rounded-lg hover:bg-teal-800 shadow-xl transition-all mt-4 border border-teal-950">
                            {loading ? 'Connexion...' : 'Connexion'}
                        </button>
                    </form>
                    <div className="mt-6 text-center pt-4 border-t border-gray-100">
                        <Link to="/admin" className="text-sm font-bold text-teal-600 hover:underline">üîí Acc√®s Professeur</Link>
                    </div>
                </div>
            </div>
        );
    }

    const dimancheFin = ajouterJours(lundiActuel, 6);
    const isDebt = (student.absARemplacer || 0) < 0;
    // Helper pour le texte du solde
    const soldeClass = isDebt ? "bg-red-100 text-red-800 border-red-200" : "bg-teal-100 text-teal-800 border-teal-200";
    const getSoldeLabel = (val) => {
        const solde = val || 0;
        if (solde > 0) return `S√©ance(s) √† rattraper : ${solde}`;
        if (solde < 0) return `S√©ance(s) √† payer : ${Math.abs(solde)}`;
        return "Aucune s√©ance √† rattraper";
    };

    // --- NOUVEAU : LOGIQUE STATUT ABONNEMENT ---
    const hasSubscriptions = student.enrolledGroupIds && student.enrolledGroupIds.length > 0;
    let subscriptionStatus = 'none'; // none, ok, late
    if (hasSubscriptions) {
        // V√©rifier si TOUS les groupes inscrits sont pay√©s
        const allPaid = student.enrolledGroupIds.every(gid => student.payments?.[gid] === true);
        subscriptionStatus = allPaid ? 'ok' : 'late';
    }

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col font-sans">
            {/* HEADER */}
            <header className="bg-white border-b sticky top-0 z-30 shadow-sm px-4 py-3 flex justify-between items-center gap-2">
                <div className="flex items-center gap-4">
                    <h1 className="font-playfair font-bold text-xl text-teal-900 hidden md:block">{student.prenom} {student.nom}</h1>

                    <button
                        onClick={() => setShowHistory(true)}
                        className={`hidden md:inline-flex items-center gap-2 text-xs font-bold px-3 py-1 rounded-full border transition hover:shadow-md cursor-pointer ${soldeClass}`}
                        title="Voir l'historique"
                    >
                        <span>{getSoldeLabel(student.absARemplacer)}</span>
                        <span className="text-xs opacity-50">‚ÑπÔ∏è</span>
                    </button>

                    {/* --- BOUTON ABONNEMENT (Desktop) --- */}
                    {hasSubscriptions && (
                        <div className={`hidden md:flex items-center gap-2 px-3 py-1 rounded-full border text-xs font-bold ${subscriptionStatus === 'ok' ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200'}`}>
                            <span>{subscriptionStatus === 'ok' ? '‚úÖ Abonnement √† jour' : '‚ö†Ô∏è Abonnement √† r√©gulariser'}</span>
                        </div>
                    )}
                </div>

              {/* NAVIGATION SEMAINE AVEC S√âLECTEUR DE DATE */}
<div className="flex items-center bg-gray-100 rounded-lg p-1 mt-3 md:mt-0 gap-1">
   <button 
        type="button" 
        onClick={() => setLundiActuel(prev => ajouterJours(prev, -7))} 
        className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600 font-bold transition"
    >
        ‚Üê
    </button>
    
    {/* --- S√âLECTEUR DE DATE ROBUSTE --- */}
    <div className="relative group">
        <input 
            type="date" 
            id="date-picker-prof" 
            className="absolute opacity-0 w-0 h-0" 
            onChange={(e) => {
                if(e.target.value) setLundiActuel(getLundi(new Date(e.target.value)));
            }}
        />
        <button 
            type="button" 
            onClick={() => {
                try {
                    document.getElementById('date-picker-prof').showPicker();
                } catch (e) {
                    document.getElementById('date-picker-prof').focus();
                }
            }}
            className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600 font-bold transition cursor-pointer"
        >
            üìÖ
        </button>
    </div>

    <button 
        type="button" 
        onClick={() => setLundiActuel(getLundi(new Date()))} 
        className="px-3 py-1 hover:bg-white rounded-md text-teal-700 font-bold text-sm uppercase transition"
    >
        Auj.
    </button>
<button 
        type="button" 
        onClick={() => setLundiActuel(prev => ajouterJours(prev, 7))} 
        className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-md text-gray-600 font-bold transition"
    >
        ‚Üí
    </button>
</div>
                <div className="flex items-center gap-3">
                    {/* BOUTON FILTRE MES COURS */}
                    <button
                        onClick={() => setOnlyMyCourses(!onlyMyCourses)}
                        className={`text-xs font-bold px-3 py-1.5 rounded-lg border transition flex items-center gap-1 ${onlyMyCourses ? 'bg-teal-600 text-white border-teal-600' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}`}
                    >
                        <span>{onlyMyCourses ? 'üëÅÔ∏è Mes cours' : 'üëÅÔ∏è Tout voir'}</span>
                    </button>

                    {/* Mobile Badges Group√©s */}
                    <div className="flex flex-col gap-1 md:hidden items-end">
                        <button
                            onClick={() => setShowHistory(true)}
                            className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${soldeClass}`}
                        >
                        {student.absARemplacer !== 0 ? (student.absARemplacer > 0 ? `+${student.absARemplacer}` : student.absARemplacer) : '0'}
                        </button>
                        {hasSubscriptions && (
                             <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${subscriptionStatus === 'ok' ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200'}`}>
                                {subscriptionStatus === 'ok' ? 'Abo ‚úÖ' : 'Abo ‚ö†Ô∏è'}
                             </span>
                        )}
                    </div>

                    <Link to="/" className="text-gray-400 hover:text-teal-600 text-xs font-bold mr-2 hidden md:block">Accueil</Link>
                    <button onClick={() => setStudent(null)} className="text-sm font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded transition">
                        Sortir
                    </button>
                </div>
            </header>

            <main className="flex-1 overflow-auto p-2 md:p-6 relative">

                {/* VUE MOBILE */}
                <div className="block md:hidden space-y-4 pb-20">
                    {loadingPlanning ? (
                        // SKELETON MOBILE
                        <div className="space-y-6 p-4">
                            {[1, 2, 3].map(i => (
                                <div key={i} className="pl-3 border-l-2 border-gray-200 space-y-2">
                                    <Skeleton className="h-4 w-24 mb-2" />
                                    <Skeleton className="h-20 w-full rounded-lg" />
                                    <Skeleton className="h-20 w-full rounded-lg" />
                                </div>
                            ))}
                        </div>
                    ) : (
                        [0, 1, 2, 3, 4, 5, 6].map(offset => {
                            const dateJour = ajouterJours(lundiActuel, offset);
                            // UTILISATION DU FILTRE ICI
                            const sessions = sessionsAffichees.filter(s => s.dateObj.toDateString() === dateJour.toDateString());
                            if (sessions.length === 0) return null;

                            return (
                                <div key={offset} className="pl-3 border-l-2 border-gray-200 relative">
                                    <div className="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-teal-500"></div>
                                    <h3 className="font-bold text-gray-500 mb-2 uppercase text-xs">
    {dateJour.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
</h3>
                                    <div className="space-y-2">
                                        {sessions.map(sess => {
                                            if (sess.estAnnule) {
                                                return (
                                                    <div key={sess.seanceId} className="p-3 rounded-lg border border-gray-200 bg-gray-100 opacity-75 flex justify-between items-center">
                                                        <div>
                                                            <div className="font-bold text-gray-500 line-through decoration-gray-400">{sess.groupe.nom}</div>
                                                            <div className="text-xs font-mono text-gray-400">{sess.groupe.heureDebut}</div>
                                                            {sess.motifAnnulation && (
                                                                <div className="text-xs font-bold text-red-500 mt-1 italic">
                                                                    "{sess.motifAnnulation}"
                                                                </div>
                                                            )}
                                                        </div>
                                                        <span className="text-xs font-black uppercase text-red-500 border border-red-200 px-2 py-1 rounded bg-white">ANNUL√â</span>
                                                    </div>
                                                );
                                            }

                                            // --- COULEURS ET STYLES MOBILE ---
                                            const isFull = sess.placesRestantes <= 0;
                                            let bg = "bg-white border-gray-200";
                                            let containerStyle = "active:scale-95 transition-transform flex justify-between items-center cursor-pointer";

                                            if (sess.isPast) {
                                                // GRIS√â SI PASS√â
                                                bg = "bg-gray-50 border-gray-200 opacity-60 grayscale-[80%]";
                                                containerStyle = "flex justify-between items-center cursor-pointer"; // Pas d'effet de clic
                                            } else {
                                                if (sess.type === 'ajout') {
                                                    bg = "bg-purple-50/50 border-purple-200"; // VIOLET
                                                } else if (isFull) {
                                                    bg = "bg-red-50/50 border-red-200"; // ROUGE SI COMPLET
                                                } else {
                                                    bg = "bg-teal-50/30 border-teal-200"; // VERT SINON
                                                }
                                            }

                                            let centerText = null;
                                            if (sess.estInscritRecurrent) {
                                                if (sess.isMeAbsent) centerText = "ABSENT";
                                                else centerText = "INSCRIT";
                                            } else if (sess.isMeGuest) {
                                                centerText = "R√âSERV√â";
                                            } else if (sess.isInWaitingList) {
                                                centerText = `ATTENTE ${sess.waitingListPosition}`;
                                            }

                                            return (
                                                <div key={sess.seanceId} onClick={() => setSelectedSession(sess)} className={`p-3 rounded-lg border shadow-sm ${bg} ${containerStyle}`}>
                                                    <div>
                                                        <div className="font-bold text-gray-800">{sess.groupe.nom}</div>
                                                        <div className="text-xs font-mono text-gray-500">{sess.groupe.heureDebut}</div>
                                                        {sess.groupe.theme && <div className="text-xs text-purple-600 italic mt-0.5">"{sess.groupe.theme}"</div>}
                                                        <div className={`text-xs mt-1 ${isFull && !sess.isPast ? "text-red-500" : "text-green-600"}`}>
                                                            {getPlacesLabel(sess.placesRestantes)}
                                                        </div>
                                                    </div>
                                                    {centerText && (
                                                        <span className={`text-xs font-black uppercase tracking-wider px-2 py-1 rounded border shadow-sm ${centerText === 'ABSENT' ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-white text-gray-800 border-gray-200'}`}>
                                                            {centerText}
                                                        </span>
                                                    )}
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            )
                        })
                    )}
                </div>

                {/* VUE DESKTOP */}
                <div className="hidden md:flex bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden relative min-h-[600px]">
                    <div className="w-16 bg-gray-50 border-r border-gray-200 flex-shrink-0 relative" style={{ height: (HEURE_FIN - HEURE_DEBUT) * PIXELS_PAR_HEURE }}>
                        {Array.from({ length: HEURE_FIN - HEURE_DEBUT }).map((_, i) => (
                            <div key={i} className="absolute w-full text-center text-xs text-gray-400 font-bold border-b border-gray-100" style={{ top: i * PIXELS_PAR_HEURE, height: PIXELS_PAR_HEURE }}>
                                {i + HEURE_DEBUT}:00
                            </div>
                        ))}
                    </div>

                    <div className="flex-1 grid grid-cols-7 divide-x divide-gray-200 relative">

                        {loadingPlanning && (
                            <div className="absolute inset-0 z-50 bg-white/80 backdrop-blur-sm flex items-center justify-center">
                                <div className="flex flex-col items-center gap-3">
                                    <div className="w-12 h-12 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin"></div>
                                    <span className="text-teal-800 font-bold animate-pulse">Chargement du planning...</span>
                                </div>
                            </div>
                        )}

                        {[1, 2, 3, 4, 5, 6, 0].map((jourIndex) => {
                            const dateJour = ajouterJours(lundiActuel, jourIndex === 0 ? 6 : jourIndex - 1);
                            // UTILISATION DU FILTRE ICI
                            const sessions = sessionsAffichees.filter(s => s.dateObj.getDay() === jourIndex);

                            return (
                                <div key={jourIndex} className="relative" style={{ height: (HEURE_FIN - HEURE_DEBUT) * PIXELS_PAR_HEURE }}>
                                    <div className="text-center py-2 border-b border-gray-200 sticky top-0 z-10 bg-gray-50 text-gray-600">
                                        <div className="text-xs uppercase">{JOURS[jourIndex].substring(0, 3)}</div>
                                        <div className="text-lg">{dateJour.getDate()}</div>
                                    </div>
                                    {Array.from({ length: HEURE_FIN - HEURE_DEBUT }).map((_, i) => (
                                        <div key={i} className="absolute w-full border-b border-gray-100" style={{ top: i * PIXELS_PAR_HEURE, height: PIXELS_PAR_HEURE }}></div>
                                    ))}

                                    {sessions.map(sess => {
                                        const stylePos = getCardStyle(sess.groupe.heureDebut, sess.groupe.duree);

                                        // --- GESTION ANNUL√â ---
                                        if (sess.estAnnule) {
                                            return (
                                                <div
                                                    key={sess.seanceId}
                                                    className="absolute left-1 right-1 rounded-md p-2 overflow-hidden flex flex-col justify-center items-center z-20 bg-gray-100 border border-gray-300 opacity-80 cursor-not-allowed"
                                                    style={stylePos}
                                                >
                                                    <div className="text-xs font-bold text-gray-400 line-through decoration-gray-400 mb-1">{sess.groupe.nom}</div>
                                                    <div className="bg-white border border-red-200 text-red-500 font-black text-xs px-2 py-1 rounded shadow-sm transform -rotate-6 mb-1">
                                                        ANNUL√â
                                                    </div>
                                                    {/* Affichage Motif Desktop */}
                                                    {sess.motifAnnulation && (
                                                        <div className="text-[10px] text-gray-500 text-center leading-tight italic px-1">
                                                            {sess.motifAnnulation}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        }

                                        // --- COULEURS ET STYLES DESKTOP ---
                                        const isFull = sess.placesRestantes <= 0;
                                        let containerClass = "hover:shadow-md cursor-pointer border-l-4 transition-all opacity-95 hover:opacity-100 flex flex-col justify-between";
                                        let titleColor = "text-gray-700";

                                        if (sess.isPast) {
                                            // PASS√â
                                            containerClass += " bg-gray-100 border-gray-300 opacity-70 grayscale";
                                            titleColor = "text-gray-500";
                                        } else {
                                            if (sess.type === 'ajout') {
                                                // VIOLET
                                                containerClass += " bg-purple-50 border-purple-500 hover:bg-purple-100";
                                                titleColor = "text-purple-900";
                                            } else if (isFull) {
                                                // ROUGE (Complet)
                                                containerClass += " bg-red-50 border-red-500 hover:bg-red-100";
                                                titleColor = "text-red-900";
                                            } else {
                                                // VERT (Standard)
                                                containerClass += " bg-teal-50 border-teal-500 hover:bg-teal-100";
                                                titleColor = "text-teal-900";
                                            }
                                        }

                                        // 2. Badges & Overlays (Statut El√®ve)
                                        let topBadge = null;
                                        let centerOverlay = null;

                                        if (sess.type === 'ajout' && !sess.isMeGuest && !sess.isPast) {
                                            topBadge = <span className="text-[9px] font-bold text-purple-700 bg-white/80 px-1 rounded">SP√âCIAL</span>;
                                        }

                                        if (sess.estInscritRecurrent) {
                                            if (sess.isMeAbsent) {
                                                centerOverlay = <div className="text-orange-600/80 bg-orange-100/90 px-2 py-1 rounded font-black text-sm -rotate-12 border-2 border-orange-300">ABSENT</div>;
                                            } else {
                                                centerOverlay = (
                                                    <div className="bg-white/90 px-3 py-1 rounded-lg border-2 border-teal-600 shadow-sm flex items-center gap-1 z-10">
                                                        <span className="text-teal-700 font-black text-xs tracking-widest">INSCRIT</span>
                                                        <span className="text-teal-600 text-xs">‚úÖ</span>
                                                    </div>
                                                );
                                            }
                                        } else if (sess.isMeGuest) {
                                            centerOverlay = (
                                                <div className="bg-white/90 px-3 py-1 rounded-lg border-2 border-purple-600 shadow-sm flex items-center gap-1 z-10">
                                                    <span className="text-purple-700 font-black text-xs tracking-widest">R√âSERV√â</span>
                                                    <span className="text-purple-600 text-xs">üéâ</span>
                                                </div>
                                            );
                                        } else if (sess.isInWaitingList) {
                                            centerOverlay = (
                                                <div className="bg-orange-100 text-orange-800 font-bold px-2 py-1 rounded text-xs z-10 shadow-sm border border-orange-200">
                                                    FILE D'ATTENTE : {sess.waitingListPosition}e
                                                </div>
                                            );
                                        }

                                        return (
                                            <div
                                                key={sess.seanceId}
                                                className={`absolute left-1 right-1 rounded-md p-2 overflow-hidden flex flex-col justify-between z-20 ${containerClass}`}
                                                style={stylePos}
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    setSelectedSession(sess);
                                                }}
                                            >
                                                <div className="relative z-0 pointer-events-none">
                                                    <div className="flex justify-between items-start">
                                                        {topBadge}
                                                    </div>
                                                    <div className={`font-bold text-xs leading-tight truncate mt-0.5 ${titleColor}`}>
                                                        {sess.groupe.nom}
                                                    </div>
                                                    <div className="text-[10px] text-gray-500 font-mono">
                                                        {sess.groupe.heureDebut}
                                                    </div>

                                                    {sess.groupe.theme && !sess.estInscritRecurrent && !sess.isMeGuest && (
                                                        <div className="text-[9px] text-purple-700 italic truncate mt-1 pt-1 border-t border-purple-100">
                                                            "{sess.groupe.theme}"
                                                        </div>
                                                    )}
                                                </div>

                                                {centerOverlay && (
                                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                        {centerOverlay}
                                                    </div>
                                                )}

                                                <div className="relative z-0 flex justify-between items-end border-t border-black/5 pt-1 mt-1 pointer-events-none">
                                                    <div className={`text-[10px] font-bold ${isFull && !sess.isPast ? 'text-red-500' : 'text-green-600'}`}>
                                                        {getPlacesLabel(sess.placesRestantes)}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            );
                        })}
                    </div>
                </div>
            </main>

            {/* --- MODALE D√âTAILS S√âANCE --- */}
            {selectedSession && (
                <StudentSessionDetail
                    session={selectedSession}
                    student={student}
                    onClose={() => setSelectedSession(null)}
                    onUpdate={refreshData}
                />
            )}

            {/* --- MODALE HISTORIQUE --- */}
            {showHistory && (
                <HistoryModal
                    student={student}
                    onClose={() => setShowHistory(false)}
                />
            )}
        </div>
    );
}
</file>

</files>
